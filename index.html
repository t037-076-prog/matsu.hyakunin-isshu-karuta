<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百人一首かるた対戦ゲーム</title>
    <style>
        /* =======================================
           1. CSS: デザインと巻物テーマの適用
           ======================================= */
        :root {
            /* 配色案 */
            --color-paper: #FDFDF5; /* 胡粉色 (メイン背景) */
            --color-accent: #7D7C33; /* 鶯色 (ボタン, アクセント) */
            --color-text: #1A1A1A; /* 墨色 (文字) */
            --color-frame: #B88849; /* 伽羅色 (札の縁取り) */
            --color-highlight: #E0533C; /* 朱色 (強調) */
        }

        body {
            font-family: 'serif', 'Noto Serif JP', sans-serif; /* 和風のフォントを優先 */
            background-color: var(--color-paper);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            text-align: center;
            /* 巻物の端の柄をシミュレート */
            border-top: 5px solid var(--color-accent);
            border-bottom: 5px solid var(--color-accent);
            min-height: 100vh;
        }

        /* ヘッダー/スコアエリア */
        #header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .score-box {
            font-size: 1.2em;
            font-weight: bold;
            border: 2px solid var(--color-frame);
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
        }

        /* 読み上げエリア（上の句表示） */
        #reading-area {
            margin: 30px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.85);
            border: 3px solid var(--color-frame);
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        #reading-text {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.5;
        }
        
        #instructions {
            font-size: 0.9em;
            color: var(--color-highlight);
            margin-top: 5px;
        }

        /* 札の選択肢エリア */
        #card-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .karuta-card {
            width: 250px;
            min-height: 180px;
            padding: 15px;
            border: 5px solid var(--color-frame);
            background-color: var(--color-paper);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            text-align: left;
        }

        .karuta-card:hover {
            transform: translateY(-5px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .card-text {
            font-size: 1.1em;
            font-weight: bold;
            line-height: 1.5;
            white-space: pre-line; /* 改行を反映 */
        }

        .furigana {
            display: block;
            font-size: 0.8em;
            color: var(--color-text);
            opacity: 0.7;
            margin-bottom: 5px;
        }

        /* 句の意味表示エリア */
        #meaning-display {
            margin-top: 30px;
            font-size: 1.1em;
            padding: 15px;
            border: 2px dashed var(--color-accent);
            background-color: rgba(190, 190, 190, 0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        /* ボタン、難易度設定コンテナ */
        #controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }

        button, select {
            padding: 10px 15px;
            font-size: 1em;
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }

        button:hover, select:hover {
            background-color: #646328;
        }
        
        #result-modal {
            display:none; 
            position:fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.7); 
            z-index:100; 
            align-items:center; 
            justify-content:center;
        }
    </style>
</head>
<body>

    <header>
        <h1>🌟 百人一首かるた対戦</h1>
        
        <div id="controls">
            <div id="difficulty-setting">
                <label for="difficulty">🎮 CPUの強さ：</label>
                <select id="difficulty">
                    <option value="easy">かんたん</option>
                    <option value="normal" selected>そこそこ</option>
                    <option value="hard">強い</option>
                    <option value="oni">鬼強い</option>
                </select>
            </div>
            <button id="start-button">ゲーム開始（計50枚勝負）</button>
            <button id="reset-button" style="background-color: #778899;">🔄 最初からやり直す</button>
        </div>
        
    </header>

    <div id="header-area">
        <div class="score-box">👨 プレイヤーの札: <span id="player-score">0</span>枚</div>
        <div class="score-box">🤖 CPUの札: <span id="cpu-score">0</span>枚</div>
    </div>

    <div id="reading-area">
        <div id="reading-text">ゲームを開始してください。</div>
        <div id="instructions"></div>
    </div>

    <div id="card-options">
        </div>

    <div id="meaning-display"></div>
    
    <div id="result-modal">
        <div style="background:var(--color-paper); padding:40px; border-radius:10px; border:5px solid var(--color-frame); font-size:1.5em;">
            <p id="final-message"></p>
            <button onclick="location.reload()">もう一度遊ぶ</button>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>
    
    <script>
        /* =======================================
           2. JavaScript: ゲームロジック
           ======================================= */

        // 百人一首データ (1番から100番までの全データ)
        const KARUTA_DATA = [
            { id: 1, kami: "秋の田の\nかりほの庵の\n苫をあらみ", kami_f: "あきのたの\nかりほのいおの\nとまをあらみ", shimo: "わが衣手は\n露にぬれつつ", shimo_f: "わがころもでは\nつゆにぬれつつ", meaning: "秋の田のほとりにある仮小屋の屋根をふいた苫の目があらいので、わたしの袖は夜露にぬれてばかりいる。" },
            { id: 2, kami: "春すぎて\n夏来にけらし\n白妙の", kami_f: "はるすぎて\nなつきにけらし\nしろたえの", shimo: "衣ほすてふ\n天の香具山", shimo_f: "ころもほすちょう\nあまのかぐやま", meaning: "春が過ぎて夏が来たらしい。白い衣が干されているという天の香具山よ。" },
            { id: 3, kami: "あしびきの\n山鳥の尾の\nしだり尾の", kami_f: "あしびきの\nやまどりのをの\nしだりおの", shimo: "ながながし夜を\nひとりかも寝む", shimo_f: "ながながしよを\nひとりかもねむ", meaning: "山鳥の長く垂れた尾のように、長く寂しい夜を私ひとりで寝るのだろうか。" },
            { id: 4, kami: "田子の浦に\nうち出でて見れば\n白妙の", kami_f: "たごのうらに\nうちいでてみれば\nしろたえの", shimo: "富士の高嶺に\n雪は降りつつ", shimo_f: "ふじのたかねに\nゆきはふりつつ", meaning: "田子の浦へ出て見ると、真っ白な富士の山の高い峰に、雪が降っていることだ。" },
            { id: 5, kami: "奥山に\n紅葉踏み分け\n鳴く鹿の", kami_f: "おくやまに\nもみじふみわけ\nなくしかの", shimo: "声きく時ぞ\n秋はかなしき", shimo_f: "こえきくときぞ\nあきはかなしき", meaning: "奥山で紅葉を踏み分けながら鳴いている鹿の声を聞く時こそ、秋はしみじみともの悲しいものだ。" },
            { id: 6, kami: "かささぎの\n渡せる橋に\nおく霜の", kami_f: "かささぎの\nわたせるはしに\nおくしもの", shimo: "しろきを見れば\n夜ぞふけにける", shimo_f: "しろきをみれば\nよぞふけにける", meaning: "カササギが天の川に渡したという橋に降りる霜の白いのを見ると、夜がずいぶん更けたことだとわかる。" },
            { id: 7, kami: "天の原\nふりさけ見れば\n春日なる", kami_f: "あまのはら\nふりさけみれば\nかすがなる", shimo: "三笠の山に\nいでし月かも", shimo_f: "みかさのやまに\nいでしつきかも", meaning: "空を遠く見上げると、故郷の春日にある三笠の山に出た月と同じ月が出ているのだなあ。" },
            { id: 8, kami: "わが庵は\n都のたつみ\nしかぞすむ", kami_f: "わがいおは\nみやこのたつみ\nしかぞすむ", shimo: "世をうぢ山と\n人はいふなり", shimo_f: "よをうじやまと\nひとはいうなり", meaning: "私の庵は都の東南にあり、このようにしてひっそりと住んでいるので、世間の人はここを「世を厭う山」と呼ぶらしい。" },
            { id: 9, kami: "花の色は\nうつりにけりな\nいたづらに", kami_f: "はなのいろは\nうつりにけりな\nいたずらに", shimo: "わが身世にふる\nながめせしまに", shimo_f: "わがみよにふる\nながめせしまに", meaning: "桜の花の色は、むなしくも衰え色あせてしまった。私が世間に古び、もの思いにふけっている間に。" },
            { id: 10, kami: "これやこの\n行くも帰るも\n別れつつ", kami_f: "これやこの\nゆくもかえるも\nわかれつつ", shimo: "知るも知らぬも\n逢坂の関", shimo_f: "しるもしらぬも\nおおさかのせき", meaning: "これがその、都へ下る人も上る人も別れてはまた出会う、知っている人も知らない人も越えるという、あの逢坂の関なのだろうか。" },
            { id: 11, kami: "わたの原\n八十島かけて\nこぎいでぬと", kami_f: "わたのはら\nやそしまかけて\nこぎいでぬと", shimo: "人にはつげよ\n海人の釣舟", shimo_f: "ひとにはつげよ\nあまのつりぶね", meaning: "広い海に多くの島々を目指して船を漕ぎ出していったと、都の人たちに伝えてくれ、漁師の釣舟よ。" },
            { id: 12, kami: "天つ風\n雲のかよひ路\n吹きとぢよ", kami_f: "あまつかぜ\nくものかよひぢ\nふきとぢよ", shimo: "をとめの姿\nしばしとどめむ", shimo_f: "をとめのすがた\nしばしとどめむ", meaning: "天を吹く風よ、雲の中を通っている天女の通り道を閉ざしてしまえ。舞っている乙女たちの美しい姿をもう少しこの世にとどめておきたいのだから。" },
            { id: 13, kami: "筑波嶺の\n峰よりおつる\nみなの川", kami_f: "つくばねの\nみねよりおつる\nみなのがわ", shimo: "恋ぞつもりて\n淵となりぬる", shimo_f: "こいぞつもりて\nふちとなりぬる", meaning: "筑波山の峰から流れ落ちてくる男女川（みなのがわ）のように、私の恋心も積もり積もって深い淵のようになってしまったよ。" },
            { id: 14, kami: "みちのくの\nしのぶもぢずり\nたれゆえに", kami_f: "みちのくの\nしのぶもぢずり\nたれゆえに", shimo: "乱れそめにし\nわれならなくに", shimo_f: "みだれそめにし\nわれならなくに", meaning: "陸奥（みちのく）の忍（しのぶ）で摺（す）り染めにされた乱れ模様のように、心が乱れ始めたのは、誰のせいだろうか。私のせいではないのに。" },
            { id: 15, kami: "君がため\n春の野に出でて\n若菜つむ", kami_f: "きみがため\nはるののにいでて\nわかなつむ", shimo: "わが衣手に\n雪は降りつつ", shimo_f: "わがころもでに\nゆきはふりつつ", meaning: "あなたのために、春の野に出て若菜を摘んでいると、私の衣の袖に雪が降ってきているよ。" },
            { id: 16, kami: "たち別れ\nいなばの山の\nみねにおふる", kami_f: "たちわかれ\nいなばのやまの\nみねにおふる", shimo: "まつとしきかば\n今帰り来む", shimo_f: "まつとしきかば\nいまかえりこむ", meaning: "あなたと別れて因幡（いなば）の国へ行きますが、因幡の山に生える松のように、私を待つと聞けばすぐに帰ってきましょう。" },
            { id: 17, kami: "ちはやぶる\n神代も聞かず\n竜田川", kami_f: "ちはやぶる\nかみよもきかず\nたつたがわ", shimo: "からくれなゐに\n水くくるとは", shimo_f: "からくれなゐに\nみずくくるとは", meaning: "神々の時代にも聞いたことがない。竜田川がこんなにも鮮やかな紅色に水をくくり染めにするとは。" },
            { id: 18, kami: "住の江の\n岸に寄る波\nよるさへや", kami_f: "すみのえの\nきしによるなみ\nよるさへや", shimo: "夢の通ひ路\n人めよくらむ", shimo_f: "ゆめのかよひぢ\nひとめよくらむ", meaning: "住の江の岸に寄せる波のように、夜に夢で会いに来る通路までも、人の目を避けて通っているのだろうか。" },
            { id: 19, kami: "難波潟\nみじかき芦の\nふしのまも", kami_f: "なにはがた\nみじかきあしの\nふしのまも", shimo: "あはでこの世を\n過ぐしてよとや", shimo_f: "あはでこのよを\nすぐしてよとや", meaning: "難波潟の短い葦の節と節の間ほどのわずかな時間も、会わないでこの世を過ごせというのか。" },
            { id: 20, kami: "わびぬれば\n今をいのちと\nながめには", kami_f: "わびぬれば\nいまをいのちと\nながめには", shimo: "いざ言問はむ\n都鳥", shimo_f: "いざこととわむ\nみやこどり", meaning: "つらい生活になったので、これ以上生きることを諦めている今、さあ尋ねてみよう、都鳥よ。" },
            { id: 21, kami: "今来むと\n言ひしばかりに\n長月の", kami_f: "いまこむと\nいいしばかりに\nながつきの", shimo: "有明の月を\n待ちいでつるかな", shimo_f: "ありあけのつきを\nまちいでつるかな", meaning: "今すぐ来ると言ったばかりに、九月の夜、夜明けの月が出るまで待ち明かしてしまったことだ。" },
            { id: 22, kami: "吹くからに\n秋の草木の\nしをるれば", kami_f: "ふくからに\nあきのくさきの\nしおるれば", shimo: "むべ山風を\nあらしといふらむ", shimo_f: "むべやまかぜを\nあらしといふらむ", meaning: "（山風が）吹くとすぐに、秋の草木がしおれてしまうので、なるほど山から吹く風を「荒らし」というのだろう。" },
            { id: 23, kami: "月見れば\nちぢにものこそ\n悲しけれ", kami_f: "つきみれば\nちぢにものこそ\nかなしけれ", shimo: "わが身ひとつの\n秋にはあらねど", shimo_f: "わがみひとつの\nあきにはあらねど", meaning: "月を見ると、あれこれと物事が悲しく感じられることだよ。私一人のための秋ではないのだけれど。" },
            { id: 24, kami: "このたびは\n幣もとりあへず\n手向山", kami_f: "このたびは\nぬさもとりあえず\nたむけやま", shimo: "紅葉の錦\n神のまにまに", shimo_f: "もみじのにしき\nかみのまにまに", meaning: "今回は急な旅で、お供えの幣（ぬさ）を用意することができませんでした。手向山の紅葉の美しい錦を、神様のお心のままに受け取ってください。" },
            { id: 25, kami: "名にしおはば\n逢坂山の\nさねかづら", kami_f: "なにしおはば\nおおさかやまの\nさねかづら", shimo: "人に知られで\nくるよしもがな", shimo_f: "ひとにしられで\nくるよしもがな", meaning: "名前が「さねかづら（実葛）」であるように、あなたに「さね（さね＝寝）る」ために、人に知られないで通う方法がほしい。" },
            { id: 26, kami: "小倉山\n峰のもみぢ葉\n心あらば", kami_f: "おぐらやま\nみねのもみぢば\nこころあらば", shimo: "今ひとたびの\nみゆき待たなむ", shimo_f: "いまひとたびの\nみゆきまたなむ", meaning: "小倉山の峰の紅葉の葉よ、お前に心があるならば、もう一度天皇の行幸があるまで散らずに待っていてほしい。" },
            { id: 27, kami: "みかの原\nわきて流るる\nいづみ川", kami_f: "みかのはら\nわきてながるる\nいづみがわ", shimo: "いつ見きとてか\n恋しかるらむ", shimo_f: "いつみきとてか\nこいしかるらむ", meaning: "御香（みか）の原を分けて流れる泉川よ。いつ見たと言って、あなたをこんなにも恋しく思っているのだろうか。" },
            { id: 28, kami: "山里は\n冬ぞさびしさ\nまさりける", kami_f: "やまざとは\nふゆぞさびしさ\nまさりける", shimo: "人目も草も\nかれぬと思へば", shimo_f: "ひとめもくさも\nかれぬとおもへば", meaning: "山里は冬になって寂しさが一層つのることだ。訪れる人の足跡も、草も、すべてが枯れてしまうと思うと。" },
            { id: 29, kami: "心あてに\n折らばや折らむ\n初霜の", kami_f: "こころあてに\nおらばやおらむ\nはつしもの", shimo: "おきまどはせる\n白菊の花", shimo_f: "おきまどはせる\nしらぎくのはな", meaning: "あて推量で手折るなら手折ってみようか。初霜が降りて、どこが花か霜かと見分けにくくしている白菊の花を。" },
            { id: 30, kami: "有明の\nつれなく見えし\n別れより", kami_f: "ありあけの\nつれなくみえし\nわかれより", shimo: "暁ばかり\nうきものはなし", shimo_f: "あかつきばかり\nうきものはなし", meaning: "別れの夜明けに、つれないそぶりを見せたあの別れ以来、夜明けほどつらいものはない。" },
            { id: 31, kami: "朝ぼらけ\nありあけの月と\n見るまでに", kami_f: "あさぼらけ\nありあけのつきと\nみるまでに", shimo: "吉野の里に\n降れる白雪", shimo_f: "よしののさとに\nふれるしらゆき", meaning: "夜がほのぼのと明ける頃、夜明けの月かと思うほどに、吉野の里に降っている白雪よ。" },
            { id: 32, kami: "山川に\n風のかけたる\nしがらみは", kami_f: "やまがわに\nかぜのかけたる\nしがらみは", shimo: "流れもあへぬ\nもみぢなりけり", shimo_f: "ながれもあえぬ\nもみぢなりけり", meaning: "山間の川に、風が打ちつけて作った柵（しがらみ）のように見えるものは、流れきれずにたまっている紅葉だったのだなあ。" },
            { id: 33, kami: "ひさかたの\n光のどけき\n春の日に", kami_f: "ひさかたの\nひかりのどけき\nはるのひに", shimo: "しづ心なく\n花の散るらむ", shimo_f: "しづごころなく\nはなのちるらむ", meaning: "空の光がのどかなこの春の日に、どうして落ち着いた心もなく、桜の花は散り急ぐのだろうか。" },
            { id: 34, kami: "誰をかも\n知る人にせむ\n高砂の", kami_f: "たれをかも\nしるひとにせむ\nたかさごの", shimo: "松も昔の\n友ならなくに", shimo_f: "まつもむかしの\nともならなくに", meaning: "誰を話し相手にしようか。遠い高砂の松でさえも昔からの友達ではないのだから。" },
            { id: 35, kami: "人はいさ\n心も知らず\nふるさとは", kami_f: "ひとはいさ\nこころもしらず\nふるさとは", shimo: "花ぞ昔の\n香ににほひける", shimo_f: "はなぞむかしの\nかちににほひける", meaning: "あの人の心はどうか分からないが、昔馴染みのこの里では、梅の花だけは昔と同じように美しく咲き香っているよ。" },
            { id: 36, kami: "夏の夜は\nまだ宵ながら\n明けぬるを", kami_f: "なつのよは\nまだよひながら\nあけぬるを", shimo: "雲のいづこに\n月やどるらむ", shimo_f: "くものいづこに\nつきやどるらむ", meaning: "夏の夜はまだ宵だと思っているうちに、もう明けてしまった。あの月は雲のどこに宿を取っているのだろうか。" },
            { id: 37, kami: "白露に\n風の吹きしく\n秋の野は", kami_f: "しらつゆに\nかぜのふきしく\nあきののは", shimo: "つらぬきとめぬ\n玉ぞ散りける", shimo_f: "つらぬきとめぬ\nたまぞちりける", meaning: "白露に風がしきりに吹きつける秋の野は、まるで糸を通し止めていない玉（真珠）が散り乱れているようだ。" },
            { id: 38, kami: "忘らるる\n身をば思はず\nちかひてし", kami_f: "わすらるる\nみをばおもはず\nちかひてし", shimo: "人の命の\n惜しくもあるかな", shimo_f: "ひとのいのちの\nおしくもあるかな", meaning: "忘れ去られる我が身のことはどうでもよいが、私を忘れないと神に誓ったあなたの命が、神罰で失われるのが惜しいことだ。" },
            { id: 39, kami: "浅茅生の\n小野の篠原\nしのぶれど", kami_f: "あさぢふの\nをののしのはら\nしのぶれど", shimo: "あまりてなどか\n人の恋しき", shimo_f: "あまりてなどか\nひとのこいしき", meaning: "浅茅（あさじ）が生い茂る篠原（しのはら）のように、心の中で恋心を忍んでいるのに、どうして抑えきれないほど恋しいのだろう。" },
            { id: 40, kami: "忍ぶれど\n色に出でにけり\nわが恋は", kami_f: "しのぶれど\nいろにいでにけり\nわがこひは", shimo: "ものや思ふと\n人の問ふまで", shimo_f: "ものやおもふと\nひとのとふまで", meaning: "人に知られないように我慢していたけれど、私の恋は顔色に出てしまったようだ。「物思いをしているのか」と人が尋ねるほどに。" },
            { id: 41, kami: "恋すてふ\nわが名はまだき\n立ちにけり", kami_f: "こひすてふ\nわがなはまだき\nたちにけり", shimo: "人知れずこそ\n思ひそめしか", shimo_f: "ひとしれずこそ\nおもひそめしか", meaning: "恋をしているという私の噂が、もう早くも立ってしまったよ。まだ誰にも知られずに思い始めたばかりなのに。" },
            { id: 42, kami: "契りきな\nかたみに袖を\nしぼりつつ", kami_f: "ちぎりきな\nかたみにそでを\nしぼりつつ", shimo: "末の松山\n浪こさじとは", shimo_f: "すゑのまつやま\nなみこさじとは", meaning: "（お互いに涙で）袖を絞りながら誓い合ったではないか。あの末の松山を波が越えることはないように、二人の愛は変わらないと。" },
            { id: 43, kami: "逢ひ見ての\nのちの心に\nくらぶれば", kami_f: "あひみての\nのちのこころに\nくらぶれば", shimo: "昔はものも\n思はざりけり", shimo_f: "むかしはものも\nおもはざりけり", meaning: "あなたに実際に逢った後のこの恋しい気持ちに比べると、逢う前はたいして物思いなどしていなかったのだなあ。" },
            { id: 44, kami: "逢ふことの\nたえてしなくば\nなかなかに", kami_f: "あふことの\nたえてしなくば\nなかなかに", shimo: "人をも身をも\n恨みざらまし", shimo_f: "ひとをもみをも\nうらみざらまし", meaning: "（あなたに）逢うことが全くなかったならば、かえってあなたを、そして我が身をも恨んだりはしなかっただろうに。" },
            { id: 45, kami: "あはれとも\nいふべき人は\n思ほえで", kami_f: "あはれとも\nいうべきひとは\nおもほえで", shimo: "身のいたづらに\nなりぬべきかな", shimo_f: "みのいたずらに\nなりぬべきかな", meaning: "「かわいそうに」と言ってくれるような人は見当たらなくて、私はむなしく死んでしまいそうだ。" },
            { id: 46, kami: "由良のとを\nわたる舟人\nかぢをたえ", kami_f: "ゆらのとを\nわたるふなびと\nかぢをたえ", shimo: "ゆくへも知らぬ\n恋の道かな", shimo_f: "ゆくえもしらぬ\nこひのみちかな", meaning: "由良の門を渡る舟人が櫂（かじ）を失って、どこへ行くか分からないように、私の恋の行方も分からないことだ。" },
            { id: 47, kami: "八重葎\nしげれる宿の\nさびしきに", kami_f: "やへむぐら\nしげれるやどの\nさびしきに", shimo: "人こそ見えね\n秋は来にけり", shimo_f: "ひとこそみえね\nあきはきにけり", meaning: "幾重にも葎（むぐら）が茂っている私の家の寂しいことよ。訪れる人は誰も見えないが、秋はちゃんと来てくれたのだなあ。" },
            { id: 48, kami: "風をいたみ\n岩うつ波の\nおのれのみ", kami_f: "かぜをいたみ\nいはうつなみの\nおのれのみ", shimo: "くだけてものを\n思ふころかな", shimo_f: "くだけてものを\nおもふころかな", meaning: "風が激しいので岩に打ちつける波が、自分自身だけ砕けるように、私だけが心砕けて物思いをしているこの頃だ。" },
            { id: 49, kami: "みかき守\n衛士のたく火の\n夜はもえ", kami_f: "みかきもり\nゑじのたくひの\nよはもえ", shimo: "昼は消えつつ\nものをこそ思へ", shimo_f: "ひるはきえつつ\nものをこそおもへ", meaning: "宮中の衛士が焚く火が夜は燃え、昼は消えていくように、私の恋の思いも夜は燃え上がり、昼は消え入りそうになりながら、物思いをしている。" },
            { id: 50, kami: "君がため\n惜しからざりし\n命さへ", kami_f: "きみがため\nおしからざりし\nいのちさへ", shimo: "ながくもがなと\n思ひけるかな", shimo_f: "ながくもがなと\nおもひけるかな", meaning: "あなたに逢うためなら惜しくなかった命でさえも、逢った今となっては、もっと長くありたいと思うようになったことだよ。" },
            { id: 51, kami: "かくとだに\nえやはいぶきの\nさしも草", kami_f: "かくとだに\nえやはいぶきの\nさしもぐさ", shimo: "さしも知らじな\n燃ゆる思ひを", shimo_f: "さしも知らじな\nもゆるおもひを", meaning: "「こうして恋している」とさえ言うことができない伊吹山のさしも草。あなたはこのさしも草のように、私の燃えるような思いを知らないだろうね。" },
            { id: 52, kami: "明けぬれば\n暮るるものとは\n知りながら", kami_f: "あけぬれば\nくるるものとは\nしりながら", shimo: "なほうらめしき\n朝ぼらけかな", shimo_f: "なほうらめしき\nあさぼらけかな", meaning: "夜が明ければやがて日が暮れるものだとは分かっていながらも、やはり恨めしく思われるこの別れの夜明けだよ。" },
            { id: 53, kami: "嘆きつつ\nひとり寝る夜の\n明くるまは", kami_f: "なげきつつ\nひとりぬるよの\nあくるまは", shimo: "いかに久しき\nものとかは知る", shimo_f: "いかにひさしき\nものとかはしる", meaning: "嘆きながら一人寝る夜が明けるまでの時間が、どれほど長いものか、あなたは知っているだろうか。" },
            { id: 54, kami: "忘れじの\n行く末までは\nかたければ", kami_f: "わすれじの\nゆくすゑまでは\nかたければ", shimo: "今日をかぎりの\n命ともがな", shimo_f: "きょうをかぎりの\nいのちともがな", meaning: "「あなたを忘れない」という誓いが未来永劫まで続くのは難しいかもしれないから、いっそ今日を最後にして命が絶えてほしいものだ。" },
            { id: 55, kami: "滝の音は\n絶えて久しく\nなりぬれど", kami_f: "たきのおとは\nたえてひさしく\nなりぬれど", shimo: "名こそ流れて\nなほ聞こえけれ", shimo_f: "なこそながれて\nなほきこえけれ", meaning: "滝の音は途絶えて久しくなるけれど、その名だけは流れて今も聞こえてくることだよ。" },
            { id: 56, kami: "あらざらむ\nこの世のほかに\n思ひ出に", kami_f: "あらざらむ\nこのよのほかに\nおもひでに", shimo: "今ひとたびの\n逢ふこともがな", shimo_f: "いまひとたびの\nあふこともがな", meaning: "もうすぐに死んでしまうだろうから、この世の思い出として、せめてもう一度あなたに逢いたいものだ。" },
            { id: 57, kami: "めぐりあひて\n見しやそれとも\nわかぬまに", kami_f: "めぐりあひて\nみしやそれとも\nわかぬまに", shimo: "雲がくれにし\n夜半の月かな", shimo_f: "くもがくれにし\nよはのつきかな", meaning: "久しぶりに巡り会って、その人だと確認できるかどうかの間に、あなたは雲に隠れてしまった夜半の月のような人だなあ。" },
            { id: 58, kami: "有馬山\n猪名の笹原\n風吹けば", kami_f: "ありまやま\nいなのささはら\nかぜふけば", shimo: "いでそよ人を\n忘れやはする", shimo_f: "いでそよひとを\nわすれやはする", meaning: "有馬山の猪名（いな）の笹原を風が吹くと「いな（嫌＝否）」という音がするが、「いや、まさか」人を忘れたりするものか。" },
            { id: 59, kami: "やすらはで\n寝なましものを\nさ夜ふけて", kami_f: "やすらはで\nねなましものを\nさよふけて", shimo: "かたぶくまでの\n月を見しかな", shimo_f: "かたぶくまでの\nつきをみしかな", meaning: "ためらわずに寝てしまえばよかったのに。夜が更けて、西に傾くまでの月を見て、あなたを待ち続けてしまったよ。" },
            { id: 60, kami: "大江山\nいく野の道の\n遠ければ", kami_f: "おおえやま\nいくののみちの\nとおければ", shimo: "まだふみも見ず\n天の橋立", shimo_f: "まだふみもみず\nあまのはしだて", meaning: "大江山を越え生野（いくの）へ向かう道は遠いので、まだ（母からの）手紙（ふみ）も見ていないし、天の橋立も踏んで（見て）いない。" },
            { id: 61, kami: "いにしへの\n奈良の都の\n八重桜", kami_f: "いにしへの\nならのみやこの\nやへざくら", shimo: "けふ九重に\nにほひぬるかな", shimo_f: "けふここのへに\nにほひぬるかな", meaning: "昔の都であった奈良の八重桜が、今日はこの宮中（九重）で美しく咲き誇っていることだなあ。" },
            { id: 62, kami: "夜をこめて\n鳥のそらねは\nはかるとも", kami_f: "よをこめて\nとりのそらねは\nはかるとも", shimo: "よに逢坂の\n関は許さじ", shimo_f: "よにあふさかの\nせきはゆるさじ", meaning: "まだ夜が明けないうちに、鶏の鳴き声（そらね）で人をだまそうとしても、世間に逢坂の関守はだまされて門を開けたりはしないだろう。" },
            { id: 63, kami: "今はただ\n思ひ絶えなむ\nとばかりを", kami_f: "いまはただ\nおもひたえなむ\nとばかりを", shimo: "人づてならで\nいふよしもがな", shimo_f: "ひとづてならで\nいうよしもがな", meaning: "今はただ「あなたのことをもう諦めて忘れよう」ということだけを、人づてではなく直接あなたに伝える方法があればなあ。" },
            { id: 64, kami: "朝ぼらけ\n宇治の川霧\nたえだえに", kami_f: "あさぼらけ\nうぢのかはぎり\nたえだえに", shimo: "あらはれわたる\n瀬々（せぜ）の網代木（あじろぎ）", shimo_f: "あらはれわたる\nせぜのあじろぎ", meaning: "夜明け方、宇治川にかかる川霧が途切れ途切れになるにつれて、網代木（魚を捕るための杭）が水面に姿を現し渡っていく様子だ。" },
            { id: 65, kami: "恨みわび\nほさぬ袖だに\nあるものを", kami_f: "うらみわび\nほさぬそでだに\nあるものを", shimo: "恋にくちなむ\n名こそ惜しけれ", shimo_f: "こひにくちなむ\nなこそおしけれ", meaning: "恋を恨んで泣き続け、乾く暇のない袖でさえあるというのに、恋のせいで世間に立つ浮名（うきな）によって私の名声が朽ち果てるのは惜しいことだ。" },
            { id: 66, kami: "もろともに\nあはれと思へ\n山桜", kami_f: "もろともに\nあはれとおもへ\nやまざくら", shimo: "花よりほかに\n知る人もなし", shimo_f: "はなよりほかに\nしるひともなし", meaning: "私と同じように美しくも散りやすい身を哀れと思ってくれ、山桜よ。都から遠く離れた私には、お前以外に心を知ってくれる人はいないのだから。" },
            { id: 67, kami: "春の夜の\n夢ばかりなる\n手枕に", kami_f: "はるのよの\nゆめばかりなる\nたまくらに", shimo: "かひなくたちぬ\n名の惜しきかな", shimo_f: "かひなくたちぬ\nなのをしきかな", meaning: "春の夜の夢のように短いあなたとの一夜の契りの手枕（たまくら）で、何の甲斐もなく浮名が立ってしまった。惜しいことだ。" },
            { id: 68, kami: "心にも\nあらでうき世に\nながらへば", kami_f: "こころにも\nあらでうきよに\nながらへば", shimo: "恋しかるべき\n夜半の月かな", shimo_f: "こいしかるべき\nよはのつきかな", meaning: "本心ではないが、つらいこの世に生き長らえたならば、今見たこの夜半の月をきっと恋しく思い出すだろう。" },
            { id: 69, kami: "嵐吹く\n三室の山の\nもみぢ葉は", kami_f: "あらしふく\nみむろのやまの\nもみぢばは", shimo: "竜田の川の\n錦なりけり", shimo_f: "たつたのかわの\nにしきなりけり", meaning: "嵐が吹き荒れる三室の山から吹き散らされた紅葉の葉は、竜田川の水面に浮かび、美しい錦となっていることだよ。" },
            { id: 70, kami: "さびしさに\n宿を立ち出でて\nながむれば", kami_f: "さびしさに\nやどをたちいでて\nながむれば", shimo: "いづこも同じ\n秋の夕暮", shimo_f: "いづこもをなじ\nあきのゆうぐれ", meaning: "寂しいので、家を出てあたりを見渡してみると、どこを見ても同じような、もの寂しい秋の夕暮れであった。" },
            { id: 71, kami: "夕されば\n門田の稲葉\nおとづれて", kami_f: "ゆうされば\nかどたのいなば\nおとづれて", shimo: "蘆のまろやに\n秋風ぞ吹く", shimo_f: "あしのまろやに\nあきかぜぞふく", meaning: "夕方になると、門前の田んぼの稲の葉を揺らして、仮小屋（蘆のまろや）に秋風が吹きつけてくることだ。" },
            { id: 72, kami: "音に聞く\n高師の浜の\nあだ波は", kami_f: "おとにきく\nたかしのはまの\nあだなみは", shimo: "かけじや袖の\nぬれもこそすれ", shimo_f: "かけじやそでの\nぬれもこそすれ", meaning: "噂に聞く高師（たかし）の浜のあだ波（寄せては返す波）のように、噂ばかりのあなたを頼りにするまい。袖が濡れる（涙を流す）かもしれないから。" },
            { id: 73, kami: "高砂の\n尾の上の桜\n咲きにけり", kami_f: "たかさごの\nおのへのさくら\nさきにけり", shimo: "外山のかすみ\n立たずもあらなむ", shimo_f: "とやまのかすみ\nたたずもあらなむ", meaning: "高砂の峰の桜が咲いたことだ。麓の山にかかる霞よ、立たないでいてくれればよいのに。" },
            { id: 74, kami: "憂かりける\n人を初瀬の\n山おろし", kami_f: "うかりける\nひとをはつせの\nやまおろし", shimo: "はげしかれとは\n祈らぬものを", shimo_f: "はげしかれとは\nいのらぬものを", meaning: "つれなかったあの人を恨むあまり、長谷（はつせ）寺に参詣し、「恨めしい」と祈ったけれど、まさか山の嵐のように激しくつらく当たれとは祈らなかったのに。" },
            { id: 75, kami: "契りおきし\nさせもが露を\n命にて", kami_f: "ちぎりおきし\nさせもが露を\nいのちにて", shimo: "あはれ今年の\n秋もいぬめり", shimo_f: "あはれことしの\nあきもいぬめり", meaning: "約束しておいたさしも草の露（はかない約束）を頼りに命を長らえてきたのに、ああ、今年の秋も過ぎ去ってしまうようだ。" },
            { id: 76, kami: "わたの原\n漕ぎ出でてみれば\nひさかたの", kami_f: "わたのはら\nこぎいでてみれば\nひさかたの", shimo: "雲居にまがふ\n沖つ白波", shimo_f: "くもゐにまがふ\nおきつしらなみ", meaning: "広い海に船を漕ぎ出して見てみると、空（雲居）と見分けがつかないほどに、沖の白波が立っていることだ。" },
            { id: 77, kami: "瀬をはやみ\n岩にせかるる\n滝川の", kami_f: "せをはやみ\nいわにせかるる\nたきがわの", shimo: "われても末に\nあはむとぞ思ふ", shimo_f: "われてもすえに\nあはむとぞおもふ", meaning: "流れが速くて岩にせき止められた急流が、一度は二つに分かれても、また一つになるように、私たちも別れても必ず将来は結ばれようと思う。" },
            { id: 78, kami: "淡路島\nかよふ千鳥の\n鳴く声に", kami_f: "あわじしま\nかようちどりの\nなくこゑに", shimo: "いく夜寝覚めぬ\n須磨の関守", shimo_f: "いくよねざめぬ\nすまのせきもり", meaning: "淡路島と行き来する千鳥の鳴き声で、須磨の関守は幾晩夜中に目を覚ましたことだろうか。" },
            { id: 79, kami: "秋風に\nたなびく雲の\nたえまより", kami_f: "あきかぜに\nたなびくくもの\nたえまより", shimo: "もれ出づる月の\n影のさやけさ", shimo_f: "もれいづるつきの\nかげのさやけさ", meaning: "秋風にたなびいている雲の切れ目から、こぼれ出てくる月の光の、なんと清く澄みわたっていることか。" },
            { id: 80, kami: "長からむ\n心も知らず\n黒髪の", kami_f: "ながからむ\nこころもしらず\nくろかみの", shimo: "乱れて今朝は\nものをこそ思へ", shimo_f: "みだれてけさは\nものをこそおもへ", meaning: "（私の思いが）長く続くかどうか、あなたの心は分からないが、私の黒髪が乱れている今朝は、心を乱して物思いに沈んでいる。" },
            { id: 81, kami: "ほととぎす\n鳴きつる方を\nながむれば", kami_f: "ほととぎす\nなきつるかたを\nながむれば", shimo: "ただ有明の\n月ぞ残れる", shimo_f: "ただありあけの\nつきぞのこれる", meaning: "ホトトギスが鳴いた方を眺めてみると、ただ夜明けの月が空に残っているだけだ。" },
            { id: 82, kami: "思ひわび\nさても命は\nあるものを", kami_f: "おもひわび\nさてもいのちは\nあるものを", shimo: "うきにたへぬは\n涙なりけり", shimo_f: "うきにたへぬは\nなみだなりけり", meaning: "恋に悩み苦しんで、どうにかこうにか命は保っているのに、つらさに耐えきれないのは、この涙だったのだなあ。" },
            { id: 83, kami: "世の中よ\n道こそなけれ\n思ひ入る", kami_f: "よのなかよ\nみちこそなけれ\nおもひいる", shimo: "山の奥にも\n鹿ぞ鳴くなる", shimo_f: "やまのおくにも\nしかぞなくなる", meaning: "この世は、どこへ行っても悩みから逃れられる道はない。こんなに深く分け入った山の奥でさえ、鹿が悲しそうに鳴いていることだ。" },
            { id: 84, kami: "ながらへば\nまたこのごろや\nしのばれむ", kami_f: "ながらへば\nまたこのごろや\nしのばれむ", shimo: "憂しと見し世ぞ\n今ぞ恋しき", shimo_f: "うしとみしよぞ\nいまぞこひしき", meaning: "もし生き長らえたら、このつらい今この頃のこともまた懐かしく思い出されるだろうか。昔つらいと思っていたあの時でさえ、今となっては恋しいのだから。" },
            { id: 85, kami: "夜もすがら\n物思ふころは\n明けくれの", kami_f: "よもすがら\nものおもふころは\nあけくれの", shimo: "ただありあけの\n月ぞ見えける", shimo_f: "ただありあけの\nつきぞみえける", meaning: "一晩中物思いをしているこの頃は、明けても暮れても空に見えるのは夜明けの月だけだ。（夜明けの別れを繰り返すつらさ）" },
            { id: 86, kami: "嘆けとて\n月やはものを\n思はする", kami_f: "なげけとて\nつきやはものを\nおもはする", shimo: "かこち顔なる\nわが涙かな", shimo_f: "かこちがほなる\nわがなみだかな", meaning: "「嘆け」と言って、月が私に物思いをさせているのだろうか、いやそんなことはない。それなのに月のせいだと言わんばかりに流れる私の涙だなあ。" },
            { id: 87, kami: "村雨の\n露もまだひぬ\nまきの葉に", kami_f: "むらさめの\nつゆもまだひぬ\nまきのはに", shimo: "霧立ちのぼる\n秋の夕暮", shimo_f: "きりたちのぼる\nあきのゆうぐれ", meaning: "にわか雨の露がまだ乾ききらない槇（まき）の葉に、霧が立ち上っている秋の夕暮れの景色よ。" },
            { id: 88, kami: "難波江の\n芦のかりねの\nひとよゆゑ", kami_f: "なにはえの\nあしのかりねの\nひとよゆゑ", shimo: "みをつくしてや\n恋ひわたるべき", shimo_f: "みをつくしてや\nこひわたるべき", meaning: "難波江の葦の刈り根のような、わずか一夜（ひとよ）の契りのために、この身（澪標＝みおつくし）を尽くして恋い続けるのだろうか。" },
            { id: 89, kami: "玉の緒よ\n絶えなば絶えね\nながらへば", kami_f: "たまのおよ\nたえなばたえね\nながらへば", shimo: "忍ぶることの\n弱りもぞする", shimo_f: "しのぶることの\nよわりもぞする", meaning: "命よ、絶えるなら今すぐ絶えてしまえ。もし生き長らえたなら、人目を忍ぶ恋心が弱ってしまうかもしれないから。" },
            { id: 90, kami: "見せばやな\n雄島の海士の\n袖だにも", kami_f: "みせばやな\nをじまのあまの\nそでだにも", shimo: "ぬれにぞぬれし\n色は変はらず", shimo_f: "ぬれにぞぬれし\nいろはかわらず", meaning: "見せてやりたいものだ。雄島（おしま）の漁師の袖でさえ、潮に濡れに濡れても色は変わらないように、私の変わらぬ心も濡れているのだと。" },
            { id: 91, kami: "きりぎりす\n鳴くや霜夜の\nさむしろに", kami_f: "きりぎりす\nなくやしもよの\nさむしろに", shimo: "衣かたしき\nひとりかも寝む", shimo_f: "ころもかたしき\nひとりかもねむ", meaning: "コオロギ（きりぎりす）が鳴いている霜の降る夜のむしろの上に、自分の着物（衣）の片袖を敷いて、一人寂しく寝るのだろうか。" },
            { id: 92, kami: "わが袖は\n潮干に見えぬ\n沖の石の", kami_f: "わがそでは\nしほひにみえぬ\nおきのいしの", shimo: "人こそ知らね\nかわくまもなし", shimo_f: "ひとこそしらね\nかわくまもなし", meaning: "私の袖は、潮が引いても姿を見せない沖の石のように、人に知られていないが、恋の涙で乾く暇がない。" },
            { id: 93, kami: "世の中は\n常にもがもな\n渚こぐ", kami_f: "よのなかは\nつねにもがもな\nなぎさこぐ", shimo: "海人の小舟の\n綱手かなしも", shimo_f: "あまのこぶねの\nつなでかなしも", meaning: "この世の中はいつも変わらないでほしいものだ。渚を漕ぎ進む漁師の小舟が、網をたぐる綱の音（つなで）がなんとも心惹かれる（愛おしい）ことだ。" },
            { id: 94, kami: "みよし野の\n山の秋風\nさよふけて", kami_f: "みよしのの\nやまのあきかぜ\nさよふけて", shimo: "ふるさと寒く\n衣打つなり", shimo_f: "ふるさとさむく\nころもうつなり", meaning: "吉野の山から吹く秋風が、夜が更けるにつれて里を寒くし、衣を砧（きぬた）で打つ音が聞こえてくることだ。" },
            { id: 95, kami: "おほけなく\nうき世の民に\nおほふかな", kami_f: "おほけなく\nうきよのたみに\nおほふかな", shimo: "わが立つ杣に\n墨染の袖", shimo_f: "わがたつそまに\nすみぞめのそで", meaning: "身の程知らずにも、つらい世の民衆を救おうと、私が暮らす比叡山で着ている僧衣の袖で包み込むことだ。（人々に慈悲をかける決意）" },
            { id: 96, kami: "花さそふ\n嵐の庭の\n雪ならで", kami_f: "はなさそふ\nあらしのにわの\nゆきならで", shimo: "ふりゆくものは\nわが身なりけり", shimo_f: "ふりゆくものは\nわがみなりけり", meaning: "花を散らす嵐が庭に吹き、雪のように見えているが、本当に降り積もって古びていくものは、花ではなく、私のこの身だったのだなあ。" },
            { id: 97, kami: "来ぬ人を\n松帆の浦の\n夕なぎに", kami_f: "こぬひとを\nまつほのうらの\nゆうなぎに", shimo: "焼くや藻塩の\n身もこがれつつ", shimo_f: "やくやもしほの\nみもこがれつつ", meaning: "来ない人を「待つ（まつ）」松帆の浦の夕なぎ時に、藻塩（もしお）を焼く炎のように、私の身も焦がれながら恋い慕っている。" },
            { id: 98, kami: "風そよぐ\nならの小川の\n夕暮は", kami_f: "かぜそよぐ\nならのおがわの\nゆうぐれは", shimo: "みそぎぞ夏の\nしるしなりける", shimo_f: "みそぎぞなつの\nしるしなりける", meaning: "風がそよそよと音を立てるならの小川の夕暮れは、涼しくて秋のようだが、川で行われている禊（みそぎ）の行事こそが夏の終わりを告げる印だったのだなあ。" },
            { id: 99, kami: "ももしくや\n古き軒端の\nしのぶにも", kami_f: "ももしきや\nふるきのきばの\nしのぶにも", shimo: "なほあまりある\n昔なりけり", shimo_f: "なほあまりある\nむかしなりけり", meaning: "宮中の古びた軒先に生えている忍（しのぶぐさ）を見ても、それでもなお思い出しきれないほど、懐かしい昔の世であったことよ。" },
            { id: 100, kami: "大君は\n神にしあらず\nますらをの", kami_f: "おほきみは\nかみにしあらず\nますらをの", shimo: "ふねのつまもりに\nたつなみやどる", shimo_f: "ふねのつまもりに\nたつなみやどる", meaning: "（意味は諸説あるため割愛されることも多いですが、一般的な解釈として）天皇は神ではない。立派な男子である私が、船の舳先（へさき）を守る時に立つ波のように、命がけであなたを護る（つまもり）でしょう。" }
        ];

        let playerScore = 0;
        let cpuScore = 0;
        let currentRound = 0;
        const MAX_ROUNDS = 50; 
        let isReading = false;
        let isGameActive = false;
        let correctAnswerId = null;
        let cpuTimeout = null;
        let availableCards = []; 
        
        const difficultySettings = {
            easy: { minTime: 3500, maxTime: 6000, missChance: 0.3 }, 
            normal: { minTime: 2000, maxTime: 4000, missChance: 0.1 }, 
            hard: { minTime: 500, maxTime: 1500, missChance: 0.05 }, 
            oni: { minTime: 100, maxTime: 500, missChance: 0.01 } 
        };

        const scorePlayerEl = document.getElementById('player-score');
        const scoreCpuEl = document.getElementById('cpu-score');
        const readingTextEl = document.getElementById('reading-text');
        const instructionsEl = document.getElementById('instructions');
        const cardOptionsEl = document.getElementById('card-options');
        const meaningDisplayEl = document.getElementById('meaning-display');
        const difficultySelectEl = document.getElementById('difficulty');
        const startButtonEl = document.getElementById('start-button');
        const resetButtonEl = document.getElementById('reset-button'); // 追加
        const resultModalEl = document.getElementById('result-modal');
        const finalMessageEl = document.getElementById('final-message');

        const utterance = new SpeechSynthesisUtterance();
        utterance.lang = 'ja-JP';

        /**
         * 日本語の句を読み上げる
         */
        function speak(text) {
            utterance.text = text.replace(/\n/g, ' '); 
            window.speechSynthesis.speak(utterance);
        }

        /**
         * ゲームを初期化して開始
         */
        function startGame() {
            if (isGameActive) return;

            playerScore = 0;
            cpuScore = 0;
            currentRound = 0;
            
            // 100首からランダムに50首を選んで出題リストを作成
            const shuffledKaruta = [...KARUTA_DATA].sort(() => Math.random() - 0.5);
            availableCards = shuffledKaruta.slice(0, MAX_ROUNDS); 
            
            isGameActive = true;
            scorePlayerEl.textContent = playerScore;
            scoreCpuEl.textContent = cpuScore;
            readingTextEl.textContent = "第一回戦を開始します。";
            instructionsEl.textContent = '🔊 音声を聞いて、読み上げた上の句に合う下の句を取ろう。（読み上げ中でも取っても良いよ！）';
            meaningDisplayEl.style.opacity = '0';
            startButtonEl.disabled = true;
            difficultySelectEl.disabled = true;
            resetButtonEl.disabled = false; // リセットボタンを有効にする

            setTimeout(nextRound, 2000);
        }

        /**
         * ゲームをリセット（初期状態に戻す）する
         */
        function resetGame() {
            if (isGameActive && !confirm('本当にゲームをリセットして最初からやり直しますか？')) {
                return;
            }
            
            window.speechSynthesis.cancel(); // 読み上げを停止
            clearTimeout(cpuTimeout); // CPUのタイマーをクリア

            playerScore = 0;
            cpuScore = 0;
            currentRound = 0;
            isReading = false;
            isGameActive = false;
            correctAnswerId = null;
            availableCards = [];
            
            scorePlayerEl.textContent = '0';
            scoreCpuEl.textContent = '0';
            readingTextEl.textContent = '「ゲーム開始」ボタンを押して、遊んでみよう！';
            instructionsEl.textContent = '難易度を選んでね。計50枚勝負です。';
            cardOptionsEl.innerHTML = ''; // 札を削除
            meaningDisplayEl.style.opacity = '0'; // 意味表示を隠す
            
            startButtonEl.disabled = false; // スタートボタンを有効化
            difficultySelectEl.disabled = false;
            resetButtonEl.disabled = true; // リセットボタンを無効化
            resultModalEl.style.display = 'none'; // 結果モーダルを隠す
        }


        /**
         * 次のラウンド（句の出題）へ進む
         */
        function nextRound() {
            if (currentRound >= MAX_ROUNDS) {
                endGame();
                return;
            }

            currentRound++;
            readingTextEl.textContent = `第 ${currentRound} 回戦 (${MAX_ROUNDS}戦中)...`;
            cardOptionsEl.innerHTML = '';
            meaningDisplayEl.style.opacity = '0';
            isReading = true;
            clearTimeout(cpuTimeout);
            
            // 正解の札を選ぶ (availableCardsから順番に取り出す)
            const correctCard = availableCards[currentRound - 1]; 
            correctAnswerId = correctCard.id;
            
            // 不正解の札2枚を選ぶ
            let incorrectCards = [];
            const allIncorrectCandidates = KARUTA_DATA.filter(card => card.id !== correctAnswerId);

            while (incorrectCards.length < 2 && allIncorrectCandidates.length > 0) {
                const randomIndex = Math.floor(Math.random() * allIncorrectCandidates.length);
                const selectedCard = allIncorrectCandidates[randomIndex];
                incorrectCards.push(selectedCard);
                allIncorrectCandidates.splice(randomIndex, 1);
            }
            
            // 選択肢リストを作成し、シャッフル
            let options = [correctCard, ...incorrectCards];
            options.sort(() => Math.random() - 0.5);
            
            // 画面に札を表示
            options.forEach((card, index) => {
                const cardEl = createCardElement(card, index);
                cardOptionsEl.appendChild(cardEl);
            });

            // 読み上げ開始
            setTimeout(() => {
                startReading(correctCard);
            }, 1000); 
        }

        /**
         * 札のDOM要素を作成
         */
        function createCardElement(card, index) {
            const cardEl = document.createElement('div');
            cardEl.className = 'karuta-card';
            cardEl.dataset.id = card.id;
            cardEl.dataset.index = index;
            cardEl.onclick = () => handleCardClick(card.id, 'player', index);
            
            const textLines = card.shimo.split('\n');
            const furiLines = card.shimo_f.split('\n');

            let innerHTML = '';
            for(let i = 0; i < textLines.length; i++) {
                if(furiLines[i]) {
                    innerHTML += `<span class="furigana">${furiLines[i]}</span>`;
                }
                innerHTML += `<div class="card-text">${textLines[i]}</div>`;
            }

            cardEl.innerHTML = innerHTML;
            return cardEl;
        }

        /**
         * 読み上げ（上の句の表示と音声）を開始
         */
        function startReading(card) {
            const kamiTextLines = card.kami.split('\n');
            const kamiFuriLines = card.kami_f.split('\n');
            
            let displayHTML = '';
            for(let i = 0; i < kamiTextLines.length; i++) {
                if(kamiFuriLines[i]) {
                    displayHTML += `<span class="furigana" style="font-size:0.5em; opacity:1;">${kamiFuriLines[i]}</span><br>`;
                }
                displayHTML += `${kamiTextLines[i]}<br>`;
            }
            readingTextEl.innerHTML = displayHTML;
            
            speak(card.kami);
            isReading = true;
            
            setCpuReaction(card.id);
        }

        /**
         * CPUの反応ロジック
         */
        function setCpuReaction(correctId) {
            const diff = difficultySelectEl.value;
            const settings = difficultySettings[diff];
            
            const reactionTime = Math.random() * (settings.maxTime - settings.minTime) + settings.minTime;
            
            cpuTimeout = setTimeout(() => {
                let cpuChoiceId;
                const isMiss = Math.random() < settings.missChance;
                
                if (isMiss) {
                    const incorrectOptions = Array.from(cardOptionsEl.children)
                        .map(el => parseInt(el.dataset.id))
                        .filter(id => id !== correctId);
                    
                    if (incorrectOptions.length > 0) {
                        cpuChoiceId = incorrectOptions[Math.floor(Math.random() * incorrectOptions.length)];
                    } else {
                        cpuChoiceId = correctId;
                    }
                } else {
                    cpuChoiceId = correctId;
                }

                handleCardClick(cpuChoiceId, 'cpu', -1);
            }, reactionTime);
        }


        /**
         * 札をクリック/選択した時の処理
         */
        function handleCardClick(selectedId, selector, index) {
            if (!isReading) return;
            
            clearTimeout(cpuTimeout); 
            window.speechSynthesis.cancel(); 
            isReading = false;

            const isCorrect = (selectedId === correctAnswerId);
            const cardElements = Array.from(cardOptionsEl.children);
            let resultMessage = '';
            
            if (isCorrect) {
                if (selector === 'player') {
                    playerScore++;
                    scorePlayerEl.textContent = playerScore;
                    resultMessage = `🎉 あなたの勝ち！`;
                } else {
                    cpuScore++;
                    scoreCpuEl.textContent = cpuScore;
                    resultMessage = `🤖 CPUの勝ち！`;
                }
                
                const correctCardEl = cardElements.find(el => parseInt(el.dataset.id) === selectedId);
                if (correctCardEl) {
                    correctCardEl.style.backgroundColor = '#E6E6FA'; 
                }

            } else {
                
                if (selector === 'cpu') {
                    playerScore++;
                    scorePlayerEl.textContent = playerScore;
                    resultMessage = '🎊 CPUが間違えたのであなたの勝ち！';
                } else {
                    cpuScore++;
                    scoreCpuEl.textContent = cpuScore;
                    resultMessage = '❌ 間違えた！CPUの勝ち！';
                }
                
                if (selector === 'player' && index !== -1) {
                    // プレイヤーが誤った札を選んだ場合、その札を赤く表示
                    cardElements[index].style.backgroundColor = '#FFDDE0'; 
                }
                
                // 正解の札を緑色で提示
                const correctCardEl = cardElements.find(el => parseInt(el.dataset.id) === correctAnswerId);
                if (correctCardEl) {
                    correctCardEl.style.backgroundColor = '#D0FFD0'; 
                }
            }
            
            const takenCard = KARUTA_DATA.find(card => card.id === correctAnswerId);
            readingTextEl.innerHTML = `<span style="color:${selector === 'player' ? 'var(--color-highlight)' : 'var(--color-accent)'};">${resultMessage}</span>`;
            
            meaningDisplayEl.innerHTML = `**【句の意味】** ${takenCard.meaning}`;
            meaningDisplayEl.style.opacity = '1';

            // 5秒後に次のラウンドへ
            setTimeout(nextRound, 5000); 
        }

        /**
         * ゲーム終了処理
         */
        function endGame() {
            isGameActive = false;
            startButtonEl.disabled = true; // 終了後もスタートボタンは無効
            difficultySelectEl.disabled = true;

            let message;

            if (playerScore > cpuScore) {
                message = `🏆 最終結果: ${playerScore}対${cpuScore} で**あなたの勝利です！** 素晴らしい！`;
            } else if (cpuScore > playerScore) {
                message = `残念！ 最終結果: ${playerScore}対${cpuScore} で**CPUの勝利です。** 次は頑張ろう！`;
            } else {
                message = `引き分け！ 最終結果: ${playerScore}対${cpuScore} です。`;
            }

            finalMessageEl.innerHTML = message;
            resultModalEl.style.display = 'flex';
        }

        // =======================================
        // イベントリスナー
        // =======================================
        startButtonEl.addEventListener('click', startGame);
        resetButtonEl.addEventListener('click', resetGame); // リセット機能の追加

        // ゲーム開始前の初期表示
        readingTextEl.textContent = '「ゲーム開始」ボタンを押して、遊んでみよう！';
        instructionsEl.textContent = '難易度を選んでね。計50枚勝負です。';
        resetButtonEl.disabled = true; // 最初はリセットできないように無効化

    </script>
</body>
</html>
