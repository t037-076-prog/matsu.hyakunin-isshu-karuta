<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾äººä¸€é¦–ã‹ã‚‹ãŸå¯¾æˆ¦ã‚²ãƒ¼ãƒ </title>
    <style>
        /* =======================================
           1. CSS: ãƒ‡ã‚¶ã‚¤ãƒ³ã¨å·»ç‰©ãƒ†ãƒ¼ãƒã®é©ç”¨
           ======================================= */
        :root {
            --color-paper: #FDFDF5; 
            --color-accent: #7D7C33; 
            --color-text: #1A1A1A; 
            --color-frame: #B88849; 
            --color-highlight: #E0533C; 
        }

        body {
            font-family: 'serif', 'Noto Serif JP', sans-serif; 
            background-color: var(--color-paper);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            text-align: center;
            border-top: 5px solid var(--color-accent);
            border-bottom: 5px solid var(--color-accent);
            min-height: 100vh;
        }

        #header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .score-box {
            font-size: 1.2em;
            font-weight: bold;
            border: 2px solid var(--color-frame);
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
        }

        /* èª­ã¿ä¸Šã’ã‚¨ãƒªã‚¢ï¼ˆä¸Šã®å¥è¡¨ç¤ºï¼‰ */
        #reading-area {
            margin: 10px auto; 
            padding: 15px; 
            background-color: rgba(255, 255, 255, 0.85);
            border: 3px solid var(--color-frame);
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            min-height: 100px;
        }

        #reading-text {
            font-size: 1.8em; 
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        #instructions {
            font-size: 0.9em;
            color: var(--color-highlight);
            margin-top: 5px;
        }

        /* æœ­ã®é¸æŠè‚¢ã‚¨ãƒªã‚¢ */
        #card-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .karuta-card {
            width: 250px;
            min-height: 180px;
            padding: 15px;
            border: 5px solid var(--color-frame);
            background-color: var(--color-paper);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            text-align: left;
        }

        .karuta-card:hover {
            transform: translateY(-5px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .card-text {
            font-size: 1.1em;
            font-weight: bold;
            line-height: 1.5;
            white-space: pre-line; 
        }

        .furigana {
            display: block;
            font-size: 0.8em;
            color: var(--color-text);
            opacity: 0.7;
            margin-bottom: 5px;
        }

        /* å¥ã®æ„å‘³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #meaning-display {
            margin-top: 30px;
            font-size: 1.1em;
            padding: 15px;
            border: 2px dashed var(--color-accent);
            background-color: rgba(190, 190, 190, 0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        /* ãƒœã‚¿ãƒ³ã€é›£æ˜“åº¦è¨­å®šã‚³ãƒ³ãƒ†ãƒŠ */
        #controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }

        button, select {
            padding: 10px 15px;
            font-size: 1em;
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }

        button:hover, select:hover {
            background-color: #646328;
        }
        
        /* æ¬¡ã®å¥ã¸ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #next-round-button {
            background-color: #338877;
            display: none;
        }

        #result-modal {
            display:none; 
            position:fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.7); 
            z-index:100; 
            align-items:center; 
            justify-content:center;
        }
    </style>
</head>
<body>

    <header>
        <h1>ğŸŒŸ ç™¾äººä¸€é¦–ã‹ã‚‹ãŸå¯¾æˆ¦</h1>
        
        <div id="controls">
            <div id="difficulty-setting">
                <label for="difficulty">ğŸ® CPUã®å¼·ã•ï¼š</label>
                <select id="difficulty">
                    <option value="easy">ã‹ã‚“ãŸã‚“</option>
                    <option value="normal" selected>ãã“ãã“</option>
                    <option value="hard">å¼·ã„</option>
                </select>
            </div>
            <button id="start-button">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆè¨ˆ100æšå‹è² ï¼‰</button>
            <button id="reset-button" style="background-color: #778899;">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
            <button id="next-round-button">â–¶ï¸ æ¬¡ã®å¥ã¸</button> 
        </div>
        
    </header>

    <div id="header-area">
        <div class="score-box">ğŸ‘¨ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ­: <span id="player-score">0</span>æš</div>
        <div class="score-box">ğŸ¤– CPUã®æœ­: <span id="cpu-score">0</span>æš</div>
    </div>

    <div id="reading-area">
        <div id="reading-text">ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
        <div id="instructions"></div>
    </div>

    <div id="card-options">
        </div>

    <div id="meaning-display"></div>
    
    <div id="result-modal">
        <div style="background:var(--color-paper); padding:40px; border-radius:10px; border:5px solid var(--color-frame); font-size:1.5em;">
            <p id="final-message"></p>
            <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>
    
    <script>
        /* =======================================
           2. JavaScript: ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
           ======================================= */

        // **ç™¾äººä¸€é¦–ãƒ‡ãƒ¼ã‚¿ (1ç•ªã‹ã‚‰100ç•ªã¾ã§ã®å…¨ãƒ‡ãƒ¼ã‚¿)**
        // (ãƒ‡ãƒ¼ã‚¿é•·ã®ãŸã‚ã€ã“ã®éƒ¨åˆ†ã®è¨˜è¿°ã¯çœç•¥ã—ã¾ã™ãŒã€å¿…ãš100é¦–å…¨ã¦ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„)
        const KARUTA_DATA = [
            { id: 1, kami: "ç§‹ã®ç”°ã®\nã‹ã‚Šã»ã®åºµã®\nè‹«ã‚’ã‚ã‚‰ã¿", kami_f: "ã‚ãã®ãŸã®\nã‹ã‚Šã»ã®ã„ãŠã®\nã¨ã¾ã‚’ã‚ã‚‰ã¿", shimo: "ã‚ãŒè¡£æ‰‹ã¯\néœ²ã«ã¬ã‚Œã¤ã¤", shimo_f: "ã‚ãŒã“ã‚ã‚‚ã§ã¯\nã¤ã‚†ã«ã¬ã‚Œã¤ã¤", meaning: "ç§‹ã®ç”°ã®ã»ã¨ã‚Šã«ã‚ã‚‹ä»®å°å±‹ã®å±‹æ ¹ã‚’ãµã„ãŸè‹«ã®ç›®ãŒã‚ã‚‰ã„ã®ã§ã€ã‚ãŸã—ã®è¢–ã¯å¤œéœ²ã«ã¬ã‚Œã¦ã°ã‹ã‚Šã„ã‚‹ã€‚" },
            { id: 2, kami: "æ˜¥ã™ãã¦\nå¤æ¥ã«ã‘ã‚‰ã—\nç™½å¦™ã®", kami_f: "ã¯ã‚‹ã™ãã¦\nãªã¤ãã«ã‘ã‚‰ã—\nã—ã‚ãŸãˆã®", shimo: "è¡£ã»ã™ã¦ãµ\nå¤©ã®é¦™å…·å±±", shimo_f: "ã“ã‚ã‚‚ã»ã™ã¡ã‚‡ã†\nã‚ã¾ã®ã‹ãã‚„ã¾", meaning: "æ˜¥ãŒéãã¦å¤ãŒæ¥ãŸã‚‰ã—ã„ã€‚ç™½ã„è¡£ãŒå¹²ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†å¤©ã®é¦™å…·å±±ã‚ˆã€‚" },
            // ... (98é¦–åˆ†çœç•¥ã€‚å¿…ãš100é¦–å…¨ã¦ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„) ...
            { id: 99, kami: "ã‚‚ã‚‚ã—ãã‚„\nå¤ãè»’ç«¯ã®\nã—ã®ã¶ã«ã‚‚", kami_f: "ã‚‚ã‚‚ã—ãã‚„\nãµã‚‹ãã®ãã°ã®\nã—ã®ã¶ã«ã‚‚", shimo: "ãªã»ã‚ã¾ã‚Šã‚ã‚‹\næ˜”ãªã‚Šã‘ã‚Š", shimo_f: "ãªã»ã‚ã¾ã‚Šã‚ã‚‹\nã‚€ã‹ã—ãªã‚Šã‘ã‚Š", meaning: "å®®ä¸­ã®å¤ã³ãŸè»’å…ˆã«ç”Ÿãˆã¦ã„ã‚‹å¿ï¼ˆã—ã®ã¶ãã•ï¼‰ã‚’è¦‹ã¦ã‚‚ã€ãã‚Œã§ã‚‚ãªãŠæ€ã„å‡ºã—ãã‚Œãªã„ã»ã©ã€æ‡ã‹ã—ã„æ˜”ã®ä¸–ã§ã‚ã£ãŸã“ã¨ã‚ˆã€‚" },
            { id: 100, kami: "å¤§å›ã¯\nç¥ã«ã—ã‚ã‚‰ãš\nã¾ã™ã‚‰ã‚’ã®", kami_f: "ãŠã»ãã¿ã¯\nã‹ã¿ã«ã—ã‚ã‚‰ãš\nã¾ã™ã‚‰ã‚’ã®", shimo: "ãµã­ã®ã¤ã¾ã‚‚ã‚Šã«\nãŸã¤ãªã¿ã‚„ã©ã‚‹", shimo_f: "ãµã­ã®ã¤ã¾ã‚‚ã‚Šã«\nãŸã¤ãªã¿ã‚„ã©ã‚‹", meaning: "ï¼ˆæ„å‘³ã¯è«¸èª¬ã‚ã‚‹ãŸã‚å‰²æ„›ã•ã‚Œã‚‹ã“ã¨ã‚‚å¤šã„ã§ã™ãŒã€ä¸€èˆ¬çš„ãªè§£é‡ˆã¨ã—ã¦ï¼‰å¤©çš‡ã¯ç¥ã§ã¯ãªã„ã€‚ç«‹æ´¾ãªç”·å­ã§ã‚ã‚‹ç§ãŒã€èˆ¹ã®èˆ³å…ˆï¼ˆã¸ã•ãï¼‰ã‚’å®ˆã‚‹æ™‚ã«ç«‹ã¤æ³¢ã®ã‚ˆã†ã«ã€å‘½ãŒã‘ã§ã‚ãªãŸã‚’è­·ã‚‹ï¼ˆã¤ã¾ã‚‚ã‚Šï¼‰ã§ã—ã‚‡ã†ã€‚" }
        ];

        let playerScore = 0;
        let cpuScore = 0;
        let currentRound = 0;
        // ä¿®æ­£ç‚¹1: 50ã‹ã‚‰100ã«å¤‰æ›´ (å…¨é¦–å‡ºé¡Œã«å¯¾å¿œ)
        const MAX_ROUNDS = 100; 
        let isReading = false;
        let isGameActive = false;
        let correctAnswerId = null;
        let cpuTimeout = null;
        let availableCards = []; 
        let currentReadingTime = 0; 

        // CPUã®åå¿œæ™‚é–“è¨­å®š (å‰å›ä¿®æ­£æ¸ˆã¿)
        const difficultySettings = {
            easy: { minDelay: 13000, maxDelay: 13000, missChance: 0.1 }, 
            normal: { minDelay: 11500, maxDelay: 11500, missChance: 0.05 }, 
            hard: { minDelay: 5000, maxDelay: 9000, missChance: 0.01 }, 
        };

        const scorePlayerEl = document.getElementById('player-score');
        const scoreCpuEl = document.getElementById('cpu-score');
        const readingTextEl = document.getElementById('reading-text');
        const instructionsEl = document.getElementById('instructions');
        const cardOptionsEl = document.getElementById('card-options');
        const meaningDisplayEl = document.getElementById('meaning-display');
        const difficultySelectEl = document.getElementById('difficulty');
        const startButtonEl = document.getElementById('start-button');
        const resetButtonEl = document.getElementById('reset-button'); 
        const nextRoundButtonEl = document.getElementById('next-round-button'); 
        const resultModalEl = document.getElementById('result-modal');
        const finalMessageEl = document.getElementById('final-message');

        const utterance = new SpeechSynthesisUtterance();
        utterance.lang = 'ja-JP';

        /**
         * æ—¥æœ¬èªã®å¥ã‚’èª­ã¿ä¸Šã’ã‚‹
         */
        function speak(text, callback) {
            utterance.text = text.replace(/\n/g, ' '); 
            
            utterance.onend = () => {
                isReading = false;
                if (callback) callback();
            };

            window.speechSynthesis.speak(utterance);
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã—ã¦é–‹å§‹
         */
        function startGame() {
            if (isGameActive) return;
            
            // KARUTA_DATAã®æšæ•°ã‚’ãƒã‚§ãƒƒã‚¯ (100æšå¿…è¦)
            if (KARUTA_DATA.length < 100) {
                alert(`ã‚¨ãƒ©ãƒ¼ï¼šç™¾äººä¸€é¦–100é¦–ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç¾åœ¨${KARUTA_DATA.length}æšã§ã™ã€‚`);
                return;
            }

            playerScore = 0;
            cpuScore = 0;
            currentRound = 0;
            
            // 100é¦–ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const shuffledKaruta = [...KARUTA_DATA].sort(() => Math.random() - 0.5);
            // ä¿®æ­£ç‚¹2: sliceã›ãšã€ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãŸ100æšã™ã¹ã¦ã‚’availableCardsã¨ã™ã‚‹
            availableCards = shuffledKaruta; 
            
            isGameActive = true;
            scorePlayerEl.textContent = playerScore;
            scoreCpuEl.textContent = cpuScore;
            readingTextEl.textContent = "ç¬¬ä¸€å›æˆ¦ã‚’é–‹å§‹ã—ã¾ã™ã€‚";
            instructionsEl.textContent = 'ğŸ”Š éŸ³å£°ã‚’èã„ã¦ã€èª­ã¿ä¸Šã’ãŸä¸Šã®å¥ã«åˆã†ä¸‹ã®å¥ã‚’å–ã‚ã†ã€‚ï¼ˆèª­ã¿ä¸Šã’ä¸­ã§ã‚‚å–ã£ã¦ã‚‚è‰¯ã„ã‚ˆï¼ï¼‰';
            meaningDisplayEl.style.opacity = '0';
            startButtonEl.disabled = true;
            difficultySelectEl.disabled = true;
            resetButtonEl.disabled = false;
            nextRoundButtonEl.style.display = 'none';

            setTimeout(nextRound, 2000);
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼‰ã™ã‚‹ (çœç•¥)
         */
        function resetGame() {
            if (isGameActive && !confirm('æœ¬å½“ã«ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            window.speechSynthesis.cancel(); 
            clearTimeout(cpuTimeout); 
            isGameActive = false; 

            playerScore = 0;
            cpuScore = 0;
            currentRound = 0;
            isReading = false;
            correctAnswerId = null;
            availableCards = [];
            
            scorePlayerEl.textContent = '0';
            scoreCpuEl.textContent = '0';
            readingTextEl.textContent = 'ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€éŠã‚“ã§ã¿ã‚ˆã†ï¼';
            instructionsEl.textContent = 'é›£æ˜“åº¦ã‚’é¸ã‚“ã§ã­ã€‚è¨ˆ100æšå‹è² ã§ã™ã€‚'; // UIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿®æ­£
            cardOptionsEl.innerHTML = '';
            meaningDisplayEl.style.opacity = '0';
            
            startButtonEl.disabled = false;
            difficultySelectEl.disabled = false;
            resetButtonEl.disabled = true;
            nextRoundButtonEl.style.display = 'none';
            resultModalEl.style.display = 'none';
        }


        /**
         * æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆå¥ã®å‡ºé¡Œï¼‰ã¸é€²ã‚€
         */
        function nextRound() {
            nextRoundButtonEl.style.display = 'none'; 

            if (currentRound >= MAX_ROUNDS) {
                endGame();
                return;
            }

            currentRound++; 
            // MAX_ROUNDSãŒ100ã«ãªã£ãŸãŸã‚ã€è¡¨ç¤ºã‚‚100ã«
            readingTextEl.textContent = `ç¬¬ ${currentRound} å›æˆ¦ (${MAX_ROUNDS}æˆ¦ä¸­)...`; 
            cardOptionsEl.innerHTML = '';
            meaningDisplayEl.style.opacity = '0';
            isReading = true; 
            clearTimeout(cpuTimeout);
            
            // availableCardsã¯100æšã‚ã‚Šã€currentRound-1 (0ã‹ã‚‰99) ã¯æœ‰åŠ¹ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‚
            const correctCard = availableCards[currentRound - 1]; 
            
            if (!correctCard) {
                readingTextEl.innerHTML = `è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: ${currentRound}å›æˆ¦ç›®ã®å¥ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚¹ãƒˆã‹ã‚‰è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`;
                endGame();
                return;
            }

            correctAnswerId = correctCard.id;
            
            let incorrectCards = [];
            // é–“é•ã„æœ­ã®å€™è£œã¯ã€ç¾åœ¨ã®æ­£è§£æœ­ä»¥å¤–å…¨ã¦
            const allIncorrectCandidates = KARUTA_DATA.filter(card => card.id !== correctAnswerId);

            // é–“é•ã„æœ­ã‚’2æšé¸æŠ
            while (incorrectCards.length < 2 && allIncorrectCandidates.length > 0) {
                const randomIndex = Math.floor(Math.random() * allIncorrectCandidates.length);
                const selectedCard = allIncorrectCandidates[randomIndex];
                incorrectCards.push(selectedCard);
                allIncorrectCandidates.splice(randomIndex, 1);
            }
            
            let options = [correctCard, ...incorrectCards];
            options.sort(() => Math.random() - 0.5);
            
            options.forEach((card, index) => {
                const cardEl = createCardElement(card, index);
                cardOptionsEl.appendChild(cardEl);
            });

            startReading(correctCard);
        }

        /**
         * æœ­ã®DOMè¦ç´ ã‚’ä½œæˆ (çœç•¥)
         */
        function createCardElement(card, index) {
            const cardEl = document.createElement('div');
            cardEl.className = 'karuta-card';
            cardEl.dataset.id = card.id;
            cardEl.dataset.index = index;
            cardEl.onclick = () => handleCardClick(card.id, 'player', index);
            
            const textLines = card.shimo.split('\n');
            const furiLines = card.shimo_f.split('\n');

            let innerHTML = '';
            for(let i = 0; i < textLines.length; i++) {
                if(furiLines[i]) {
                    innerHTML += `<span class="furigana">${furiLines[i]}</span>`;
                }
                innerHTML += `<div class="card-text">${textLines[i]}</div>`;
            }

            cardEl.innerHTML = innerHTML;
            return cardEl;
        }

        /**
         * èª­ã¿ä¸Šã’ï¼ˆä¸Šã®å¥ã®è¡¨ç¤ºã¨éŸ³å£°ï¼‰ã‚’é–‹å§‹ (çœç•¥)
         */
        function startReading(card) {
            const kamiTextLines = card.kami.split('\n');
            const kamiFuriLines = card.kami_f.split('\n');
            
            let displayHTML = '';
            for(let i = 0; i < kamiTextLines.length; i++) {
                if(kamiFuriLines[i]) {
                    displayHTML += `<span class="furigana" style="font-size:0.5em; opacity:1;">${kamiFuriLines[i]}</span><br>`;
                }
                displayHTML += `${kamiTextLines[i]}<br>`;
            }
            readingTextEl.innerHTML = displayHTML;
            
            setCpuReaction(card.id);

            speak(card.kami, () => {
                // èª­ã¿ä¸Šã’å®Œäº†æ™‚ã®å‡¦ç†
            });
            isReading = true;
        }

        /**
         * CPUã®åå¿œãƒ­ã‚¸ãƒƒã‚¯ (çœç•¥)
         */
        function setCpuReaction(correctId) {
            const diff = difficultySelectEl.value;
            const settings = difficultySettings[diff];
            
            const reactionTime = Math.random() * (settings.maxDelay - settings.minDelay) + settings.minDelay;
            
            cpuTimeout = setTimeout(() => {
                let cpuChoiceId;
                const isMiss = Math.random() < settings.missChance;
                
                if (isMiss) {
                    const incorrectOptions = Array.from(cardOptionsEl.children)
                        .map(el => parseInt(el.dataset.id))
                        .filter(id => id !== correctId);
                    
                    if (incorrectOptions.length > 0) {
                        cpuChoiceId = incorrectOptions[Math.floor(Math.random() * incorrectOptions.length)];
                    } else {
                        cpuChoiceId = correctId;
                    }
                } else {
                    cpuChoiceId = correctId;
                }

                if (isReading) {
                    handleCardClick(cpuChoiceId, 'cpu', -1);
                }
            }, reactionTime);
        }


        /**
         * æœ­ã‚’ã‚¯ãƒªãƒƒã‚¯/é¸æŠã—ãŸæ™‚ã®å‡¦ç† (çœç•¥)
         */
        function handleCardClick(selectedId, selector, index) {
            if (!isReading) return;
            
            clearTimeout(cpuTimeout); 
            window.speechSynthesis.cancel(); 
            isReading = false;

            const isCorrect = (selectedId === correctAnswerId);
            const cardElements = Array.from(cardOptionsEl.children);
            let resultMessage = '';
            
            if (isCorrect) {
                if (selector === 'player') {
                    playerScore++;
                    scorePlayerEl.textContent = playerScore;
                    resultMessage = `ğŸ‰ ã‚ãªãŸã®å‹ã¡ï¼`;
                } else {
                    cpuScore++;
                    scoreCpuEl.textContent = cpuScore;
                    resultMessage = `ğŸ¤– CPUã®å‹ã¡ï¼`;
                }
                
                const correctCardEl = cardElements.find(el => parseInt(el.dataset.id) === selectedId);
                if (correctCardEl) {
                    correctCardEl.style.backgroundColor = '#E6E6FA'; 
                }

            } else {
                
                if (selector === 'cpu') {
                    playerScore++;
                    scorePlayerEl.textContent = playerScore;
                    resultMessage = 'ğŸŠ CPUãŒé–“é•ãˆãŸã®ã§ã‚ãªãŸã®å‹ã¡ï¼';
                } else {
                    cpuScore++;
                    scoreCpuEl.textContent = cpuScore;
                    resultMessage = 'âŒ é–“é•ãˆãŸï¼CPUã®å‹ã¡ï¼';
                }
                
                if (selector === 'player' && index !== -1) {
                    cardElements[index].style.backgroundColor = '#FFDDE0'; 
                }
                
                const correctCardEl = cardElements.find(el => parseInt(el.dataset.id) === correctAnswerId);
                if (correctCardEl) {
                    correctCardEl.style.backgroundColor = '#D0FFD0'; 
                }
            }
            
            const takenCard = KARUTA_DATA.find(card => card.id === correctAnswerId);
            readingTextEl.innerHTML = `<span style="color:${isCorrect ? 'var(--color-highlight)' : 'var(--color-accent)'};">${resultMessage}</span>`;
            
            meaningDisplayEl.innerHTML = `**ã€å¥ã®æ„å‘³ã€‘** ${takenCard.meaning}`;
            meaningDisplayEl.style.opacity = '1';

            if (currentRound < MAX_ROUNDS) {
                nextRoundButtonEl.style.display = 'inline-block';
            } else {
                endGame(); 
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç† (çœç•¥)
         */
        function endGame() {
            isGameActive = false;
            startButtonEl.disabled = true;
            difficultySelectEl.disabled = true;
            nextRoundButtonEl.style.display = 'none';

            let message;

            if (playerScore > cpuScore) {
                message = `ğŸ† æœ€çµ‚çµæœ: ${playerScore}å¯¾${cpuScore} ã§**ã‚ãªãŸã®å‹åˆ©ã§ã™ï¼** ç´ æ™´ã‚‰ã—ã„ï¼`;
            } else if (cpuScore > playerScore) {
                message = `æ®‹å¿µï¼ æœ€çµ‚çµæœ: ${playerScore}å¯¾${cpuScore} ã§**CPUã®å‹åˆ©ã§ã™ã€‚** æ¬¡ã¯é ‘å¼µã‚ã†ï¼`;
            } else {
                message = `å¼•ãåˆ†ã‘ï¼ æœ€çµ‚çµæœ: ${playerScore}å¯¾${cpuScore} ã§ã™ã€‚`;
            }

            finalMessageEl.innerHTML = message;
            resultModalEl.style.display = 'flex';
        }

        // =======================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // =======================================
        startButtonEl.addEventListener('click', startGame);
        resetButtonEl.addEventListener('click', resetGame);
        nextRoundButtonEl.addEventListener('click', nextRound);

        readingTextEl.textContent = 'ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€éŠã‚“ã§ã¿ã‚ˆã†ï¼';
        instructionsEl.textContent = 'é›£æ˜“åº¦ã‚’é¸ã‚“ã§ã­ã€‚è¨ˆ100æšå‹è² ã§ã™ã€‚'; // UIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿®æ­£
        resetButtonEl.disabled = true;
        nextRoundButtonEl.style.display = 'none';

    </script>
</body>
</html>
