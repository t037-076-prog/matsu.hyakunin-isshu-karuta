<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 百人一首かるた対戦ゲーム</title>
    <style>
        /* =======================================
           1. CSS: デザイン設定
           ======================================= */
        :root {
            --color-primary: #8B4513; /* 茶色 (木目調) */
            --color-secondary: #FFD700; /* 金色 */
            --color-background: #F5F5DC; /* ベージュ */
            --color-paper: #FFFFF0; /* 札の色 */
            --color-frame: #A0522D; /* フレーム色 */
            --color-highlight: #4CAF50; /* 成功時の緑 */
            --color-accent: #FF6347; /* 失敗時の赤 */
        }
        body {
            font-family: 'Yu Gothic', 'Meiryo', sans-serif;
            background-color: var(--color-background);
            color: var(--color-primary);
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        header {
            margin-bottom: 20px;
            border-bottom: 3px solid var(--color-frame);
            padding-bottom: 15px;
        }
        h1 {
            color: var(--color-primary);
            font-size: 1.8em;
            margin-top: 0;
        }
        #controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--color-frame);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #8B4513;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #header-area {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .score-box {
            padding: 10px 20px;
            border: 2px solid var(--color-frame);
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: var(--color-paper);
        }
        
        /* 句の表示エリア (上の句と下の句カードエリアの間の中心) */
        #reading-area {
            background-color: var(--color-paper);
            border: 3px solid var(--color-frame);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #reading-text {
            font-size: 1.8em;
            font-weight: bold;
            line-height: 1.6;
            white-space: pre-wrap;
            min-height: 100px;
        }
        #instructions {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        /* 札の選択肢エリア */
        #card-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .karuta-card {
            background-color: var(--color-paper);
            border: 3px solid var(--color-frame);
            width: 150px;
            min-height: 200px;
            padding: 15px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.5s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 1.4em;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            white-space: pre-wrap;
            position: relative;
        }
        .karuta-card:hover {
            transform: translateY(-3px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }
        .card-text {
            line-height: 1.4;
        }
        .furigana {
            font-size: 0.4em;
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.8;
            color: #333;
        }

        /* 句の意味表示エリア */
        #meaning-display {
            background-color: #fff8e1;
            border: 1px dashed var(--color-frame);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.5s;
            text-align: left;
            white-space: pre-wrap;
        }

        /* 結果モーダル */
        #result-modal {
            display: none; 
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <header>
        <h1>🌟 百人一首かるた対戦</h1>
        
        <div id="controls">
            <div id="difficulty-setting">
                <label for="difficulty">🎮 CPUの強さ：</label>
                <select id="difficulty">
                    <option value="easy">かんたん (5秒後)</option>
                    <option value="normal" selected>そこそこ (3秒後)</option>
                    <option value="hard">強い (読み終わり直前)</option>
                </select>
            </div>
            <button id="start-button">ゲーム開始（計100枚勝負）</button>
            <button id="reset-button" style="background-color: #778899;">🔄 最初からやり直す</button>
            <button id="next-round-button" style="display:none;">▶️ 次の句へ</button> 
        </div>
        
    </header>

    <div id="header-area">
        <div class="score-box">👨 プレイヤーの札: <span id="player-score">0</span>枚</div>
        <div class="score-box">🤖 CPUの札: <span id="cpu-score">0</span>枚</div>
    </div>

    <div id="reading-area">
        <div id="reading-text">ゲームを開始してください。</div>
        <div id="instructions"></div>
    </div>

    <div id="card-options">
        </div>

    <div id="meaning-display"></div>
    
    <div id="result-modal">
        <div style="background:var(--color-paper); padding:40px; border-radius:10px; border:5px solid var(--color-frame); font-size:1.5em;">
            <p id="final-message"></p>
            <button onclick="location.reload()">もう一度遊ぶ</button>
        </div>
    </div>
    
    <script>
        /* =======================================
           2. JavaScript: ゲームロジック
           ======================================= */

        // **百人一首データ (1番から100番までの全データ)**
        const KARUTA_DATA = [
            { id: 1, kami: "秋の田の\nかりほの庵の\n苫をあらみ", kami_f: "あきのたの\nかりほのいおの\nとまをあらみ", shimo: "わが衣手は\n露にぬれつつ", shimo_f: "わがころもでは\nつゆにぬれつつ", meaning: "秋の田のかりほの庵は屋根の目が粗いので、私の袖は夜露に濡れ続けている。" },
            { id: 2, kami: "春すぎて\n夏来にけらし\n白妙の", kami_f: "はるすぎて\nなつきにけらし\nしろたえの", shimo: "衣ほすてふ\n天の香具山", shimo_f: "ころもほすちょう\nあまのかぐやま", meaning: "春が過ぎて夏が来たらしい。白い衣が干されているという天の香具山よ。" },
            { id: 3, kami: "あしびきの\n山鳥の尾の\nしだり尾の", kami_f: "あしびきの\nやまどりのをの\nしだりをの", shimo: "ながながし夜を\nひとりかも寝ん", shimo_f: "ながながしよを\nひとりかもねん", meaning: "山鳥の尾の長く垂れたように、こんな長い夜を私は一人で寝るのだろうか。" },
            { id: 4, kami: "田子の浦に\nうち出でて見れば\n白妙の", kami_f: "たごのうらに\nうちいでてみれば\nしろたえの", shimo: "富士の高嶺に\n雪は降りつつ", shimo_f: "ふじのたかねに\nゆきはふりつつ", meaning: "田子の浦に出て見ると、真っ白な富士山の高い嶺に雪が降り続いている。" },
            { id: 5, kami: "奥山に\n紅葉踏み分け\n鳴く鹿の", kami_f: "おくやまに\nもみじふみわけ\nなくしかの", shimo: "声きく時ぞ\n秋はかなしき", shimo_f: "こえきくときぞ\nあきはかなしき", meaning: "奥山で紅葉を踏み分けながら鳴く鹿の、その声を聞く時こそ秋はもの悲しいものだ。" },
            { id: 6, kami: "かささぎの\n渡せる橋に\nおく霜の", kami_f: "かささぎの\nわたせるはしに\nおくしもの", shimo: "しろきを見れば\n夜ぞふけにける", shimo_f: "しろきをみれば\nよぞふけにける", meaning: "かささぎが渡したという天の橋に、白く降りた霜を見ると、夜が更けたのだなあ。" },
            { id: 7, kami: "天の原\nふりさけ見れば\n春日なる", kami_f: "あまのはら\nふりさけみれば\nかすがなる", shimo: "三笠の山に\n出でし月かも", shimo_f: "みかさのやまに\nいでしつきかも", meaning: "大空を振り仰いで見ると、故郷の春日にある三笠山に登っていたのと同じ月が出ていることよ。" },
            { id: 8, kami: "わが庵は\n都のたつみ\nしかぞすむ", kami_f: "わがいおは\nみやこのたつみ\nしかぞすむ", shimo: "世をうぢ山と\n人はいふなり", shimo_f: "よをうじやまと\nひとはいうなり", meaning: "私の庵は都の東南、そのように（世を憂しとして）静かに暮らしている。人々はここを宇治山（憂し山）と言うらしい。" },
            { id: 9, kami: "花の色は\nうつりにけりな\nいたづらに", kami_f: "はなのいろは\nうつりにけりな\nいたづらに", shimo: "わが身世にふる\nながめせしまに", shimo_f: "わがみよにふる\nながめせしまに", meaning: "花の（桜の）色はむなしく色あせてしまったなあ。私が世の中で恋の悩みごとにふけっている間に、長雨が降っていたから。" },
            { id: 10, kami: "これやこの\n行くも帰るも\n別れては", kami_f: "これやこの\nゆくもかえるも\nわかれては", shimo: "知るも知らぬも\n逢坂の関", shimo_f: "しるもしらぬも\nおうさかのせき", meaning: "ああ、これがあの都へ行く人も帰る人も、知り合いも知らない人も皆ここで別れていくという逢坂の関なのか。" },
            { id: 11, kami: "わたの原\n八十島かけて\n漕ぎ出でぬと", kami_f: "わたのはら\nやそしまかけて\nこぎいでぬと", shimo: "人には告げよ\n海人の釣舟", shimo_f: "ひとにはつげよ\nあまのつりぶね", meaning: "大原の海に、たくさんの島々をさして船を漕ぎ出したと、都の人々に伝えてくれ、漁師の釣舟よ。" },
            { id: 12, kami: "天つ風\n雲のかよひ路\n吹きとぢよ", kami_f: "あまつかぜ\nくものかよいじ\nふきとじよ", shimo: "をとめの姿\nしばしとどめむ", shimo_f: "をとめのすがた\nしばしとどめむ", meaning: "天を吹く風よ、雲の上の通り道を吹き閉ざしておくれ。天女（舞人）の姿を、もう少しこの世に留めていたいのだから。" },
            { id: 13, kami: "筑波嶺の\n峰より落つる\nみなの川", kami_f: "つくばねの\nみねよりおつる\nみなのがわ", shimo: "恋ぞつもりて\n淵となりぬる", shimo_f: "こいぞつもりて\nふちとなりぬる", meaning: "筑波山の峰から流れ落ちてくる男女川が、いつしか深い淵となるように、私の恋心は積もり積もって淵のように深くなってしまった。" },
            { id: 14, kami: "みちのくの\nしのぶもぢずり\n誰ゆゑに", kami_f: "みちのくの\nしのぶもじずり\nたれゆえに", shimo: "乱れそめにし\nわれならなくに", shimo_f: "みだれそめにし\nわれならなくに", meaning: "陸奥の、忍ぶ摺りの模様のように、私の心が乱れ始めたのは、誰のせいでもないのに（あなたのせいで心が乱れている）" },
            { id: 15, kami: "君がため\n春の野に出でて\n若菜摘む", kami_f: "きみがため\nはるののにいでて\nわかなつむ", shimo: "わが衣手に\n雪は降りつつ", shimo_f: "わがころもでに\nゆきはふりつつ", meaning: "あなたに差し上げようと、春の野に出て若菜を摘んでいると、私の袖に雪が降りかかってくる。" },
            { id: 16, kami: "立ち別れ\nいなばの山の\n峰に生ふる", kami_f: "たちわかれ\nいなばのやまの\nみねにおうる", shimo: "まつとし聞かば\n今帰り来む", shimo_f: "まつとしきかば\nいまかえりこむ", meaning: "あなたと別れて因幡の国へ行きますが、そこの山に生える松のように、私を待っていると聞けば、すぐに帰ってきましょう。" },
            { id: 17, kami: "ちはやぶる\n神代も聞かず\n竜田川", kami_f: "ちはやぶる\nかみよもきかず\nたつたがわ", shimo: "からくれなゐに\n水くくるとは", shimo_f: "からくれなゐに\nみずくくるとは", meaning: "神代の昔でさえ聞いたことがないほど、竜田川が鮮やかな真紅に水をくくり染めにしているとは。（紅葉が水面いっぱいに広がっている様子）" },
            { id: 18, kami: "住の江の\n岸に寄る波\nよるさへや", kami_f: "すみのえの\nきしによるなみ\nよるさえや", shimo: "夢の通ひ路\n人目よくらむ", shimo_f: "ゆめのかよいじ\nひとめよくらむ", meaning: "住の江の岸に寄せる波が「夜（よる）さへ」というように、せめて夢の中でさえも、人目を避けているのだろうか。" },
            { id: 19, kami: "難波潟\nみじかき芦の\nふしのまも", kami_f: "なにはがた\nみじかきあしの\nふしのまも", shimo: "逢はでこの世を\n過ぐしてよとや", shimo_f: "あわでこのよを\nすぐしてよとや", meaning: "難波潟の短い芦の節と節の間のわずかな時間さえも逢わずに、この世を過ごせというのか。" },
            { id: 20, kami: "わびぬれば\n今はたおなじ\n難波なる", kami_f: "わびぬれば\nいまはたおなじ\nなにはなる", shimo: "みをつくしても\n逢はんとぞ思ふ", shimo_f: "みをつくしても\nあわんとぞおもう", meaning: "もうこれ以上は苦しいので、今となっては同じことだ。難波潟の澪標（みおつくし）のように、わが身を尽くしてでもあなたに逢おうと思う。" },
            { id: 21, kami: "今来むと\n言ひしばかりに\n長月の", kami_f: "いまこむと\nいいしばかりに\nながつきの", shimo: "有明の月を\n待ち出でつるかな", shimo_f: "ありあけのつきを\nまちいでつるかな", meaning: "今すぐに来る、と言った言葉を信じていたばかりに、九月（長月）の夜通し待って、とうとう有明の月を見てしまったことよ。" },
            { id: 22, kami: "吹くからに\n秋の草木の\nしをるれば", kami_f: "ふくからに\nあきのくさきの\nしおるれば", shimo: "むべ山風を\nあらしといふらむ", shimo_f: "むべやまかぜを\nあらしというらむ", meaning: "（風が）吹くとすぐに、秋の草木がしおれるので、なるほど山から吹いてくる風を「荒し（あらし）」というのだろう。" },
            { id: 23, kami: "月見れば\nちぢにものこそ\n悲しけれ", kami_f: "つきみれば\nちぢにものこそ\nかなしけれ", shimo: "わが身ひとつの\n秋にはあらねど", shimo_f: "わがみひとつの\nあきにはあらねど", meaning: "月を見ると、あれこれとものごとが悲しく感じられる。この秋が、私一人のための秋ではないけれども。" },
            { id: 24, kami: "このたびは\n幣も取りあへず\n手向山", kami_f: "このたびは\nぬさもとりあえず\nたむけやま", shimo: "紅葉の錦\n神のまにまに", shimo_f: "もみじのにしき\nかみのまにまに", meaning: "今回は旅の捧げ物（幣）を準備する暇もありませんでしたが、手向山の紅葉の美しい錦を、神様のお心のままにお受け取りください。" },
            { id: 25, kami: "名にし負はば\n逢坂山の\nさねかづら", kami_f: "なにしおわば\nおうさかやまの\nさねかづら", shimo: "人に知られで\nくるよしもがな", shimo_f: "ひとにしられで\nくるよしもがな", meaning: "その名が示す通り（逢ふ坂＝逢う）ならば、逢坂山のサネカズラのように、人知れずたぐり寄せて、あなたと逢う方法があればいいのに。" },
            { id: 26, kami: "小倉山\n峰のもみぢ葉\n心あらば", kami_f: "おぐらやま\nみねのもみじば\nこころあらば", shimo: "今ひとたびの\nみゆき待たなむ", shimo_f: "いまひとたびの\nみゆきまたなむ", meaning: "小倉山の峰の紅葉の葉よ、もしお前に心があるのならば、今一度の天皇の行幸を待って散らずに残っていてくれ。" },
            { id: 27, kami: "みかの原\nわきて流るる\nいづみ川", kami_f: "みかのはら\nわきてながるる\nいづみがわ", shimo: "いつ見きとてか\n恋しかるらむ", shimo_f: "いつみきとてか\nこいしかるらむ", meaning: "みかの原を分けて流れる泉川のように、「いつ見き」（いつ見た）という言葉と掛けて、いつ見たからといって、これほど恋しいのだろうか。" },
            { id: 28, kami: "山里は\n冬ぞさびしさ\nまさりける", kami_f: "やまざとは\nふゆぞさびしさ\nまさりける", shimo: "人目も草も\nかれぬと思へば", shimo_f: "ひとめもくさも\nかれぬとおもへば", meaning: "山里は冬が一段と寂しい。訪れる人も途絶え、草木も枯れてしまうのだと思うと。" },
            { id: 29, kami: "心あてに\n折らばや折らむ\n初霜の", kami_f: "こころあてに\nおらばやおらむ\nはつしもの", shimo: "おきまどはせる\n白菊の花", shimo_f: "おきまどはせる\nしらぎくのはな", meaning: "当て推量で手折るものならば手折ってみようか。初霜が降りて見分けがつかなくさせている白い菊の花を。" },
            { id: 30, kami: "有明の\nつれなく見えし\n別れより", kami_f: "ありあけの\nつれなくみえし\nわかれより", shimo: "暁ばかり\n憂きものはなし", shimo_f: "あかつきばかり\nうきものはなし", meaning: "有明の月のように冷淡に見えた、あの別れの時以来、夜明けほどつらいものはない。" },
            { id: 31, kami: "朝ぼらけ\nありあけの月と\n見るまでに", kami_f: "あさぼらけ\nありあけのつきと\nみるまでに", shimo: "吉野の里に\n降れる白雪", shimo_f: "よしののさとに\nふれるしらゆき", meaning: "夜明け方、空に残る有明の月かと思うほど、吉野の里に降っている白雪であるよ。" },
            { id: 32, kami: "山川に\n風のかけたる\nしがらみは", kami_f: "やまがわに\nかぜのかけたる\nしがらみは", shimo: "流れもあへぬ\n紅葉なりけり", shimo_f: "ながれもあえぬ\nもみじなりけり", meaning: "山を流れる川に、風が作りかけた柵は、流れきれずにいる紅葉であったことよ。" },
            { id: 33, kami: "ひさかたの\n光のどけき\n春の日に", kami_f: "ひさかたの\nひかりのどけき\nはるのひに", shimo: "しづ心なく\n花の散るらむ", shimo_f: "しづごころなく\nはなのちるらむ", meaning: "日の光がのどかな春の日に、どうして落ち着きもなく桜の花は散るのだろうか。" },
            { id: 34, kami: "誰をかも\n知る人にせむ\n高砂の", kami_f: "たれをかも\nしるひとにせん\nたかさごの", shimo: "松も昔の\n友ならなくに", shimo_f: "まつもむかしの\nともならなくに", meaning: "誰を親しい友としようか。高砂の松でさえも、昔からの友ではないのだから。（ここでは友を求める孤独感を表す）" },
            { id: 35, kami: "人はいさ\n心も知らず\nふるさとは", kami_f: "ひとはいさ\nこころもしらず\nふるさとは", shimo: "花ぞ昔の\n香に匂ひける", shimo_f: "はなぞむかしの\nかににおいける", meaning: "あの人の心はどうか知らないが、この故郷は昔と変わらず、梅の花だけは昔と同じ香りで咲いている。" },
            { id: 36, kami: "夏の夜は\nまだ宵ながら\n明けぬるを", kami_f: "なつのよは\nまだよひながら\nあけぬるを", shimo: "雲のいづこに\n月宿るらむ", shimo_f: "くものいづこに\nつきやどるらむ", meaning: "夏の夜はまだ宵のようだと思っていたのに、もう明けてしまった。あの月は雲のどの辺りに宿をとっているのだろうか。" },
            { id: 37, kami: "白露に\n風の吹きしく\n秋の野は", kami_f: "しらつゆに\nかぜのふきしく\nあきののは", shimo: "つらぬきとめぬ\n玉ぞ散りける", shimo_f: "つらぬきとめぬ\nたまぞちりける", meaning: "白露に風が頻繁に吹きつける秋の野は、まるで紐に通されていない玉（真珠）が散り乱れているようだ。" },
            { id: 38, kami: "忘らるる\n身をば思はず\n誓ひてし", kami_f: "わすらるる\nみをばおもわず\nちかいしし", shimo: "人の命の\n惜しくもあるかな", shimo_f: "ひとのいのちの\nおしくもあるかな", meaning: "忘れられてしまう我が身のことはどうでもよいが、神に誓って嘘をついたあなたの命が、罰を受けてしまうのが惜しい。" },
            { id: 39, kami: "浅茅生の\n小野の篠原\nしのぶれど", kami_f: "あさじうの\nをののしのはら\nしのぶれど", shimo: "あまりてなどか\n人の恋しき", shimo_f: "あまりてなどか\nひとのこいしき", meaning: "浅茅が生い茂る小野の笹原のように、この恋を人目を忍んでいるけれど、忍びきれずにどうしてこんなにもあの人が恋しいのだろう。" },
            { id: 40, kami: "忍ぶれど\n色に出でにけり\nわが恋は", kami_f: "しのぶれど\nいろにいでにけり\nわがこいは", shimo: "ものや思ふと\n人の問ふまで", shimo_f: "ものやおもうと\nひとのとうまで", meaning: "人目を忍んでいたけれど、私の恋は顔色に出てしまったようだ。「何か物思いをしているのか」と人が尋ねるまでになってしまった。" },
            { id: 41, kami: "恋すてふ\nわが名はまだき\n立ちにけり", kami_f: "こいすちょう\nわがなはまだき\nたちにけり", shimo: "人知れずこそ\n思ひそめしか", shimo_f: "ひとしれずこそ\nおもいそめしか", meaning: "恋をしているという私の噂は、早くも立ってしまった。人知れずひそかに思い始めたばかりなのに。" },
            { id: 42, kami: "ちぎりきな\nかたみに袖を\nしぼりつつ", kami_f: "ちぎりきな\nかたみにそでを\nしぼりつつ", shimo: "末の松山\n浪越さじとは", shimo_f: "すえのまつやま\nなみこさじとは", meaning: "必ず約束しましたよね、互いに涙で袖を絞りながら。末の松山が波に越されることはない、つまり永遠に心変わりしないと。" },
            { id: 43, kami: "逢ひ見ての\nのちの心に\nくらぶれば", kami_f: "あいみての\nのちのこころに\nくらぶれば", shimo: "昔はものも\n思はざりけり", shimo_f: "むかしはものも\nおもわざりけり", meaning: "（実際に）逢ってからの恋心に比べてみると、逢う前の恋の悩みなどは、何でもなかったのだなあ。" },
            { id: 44, kami: "逢ふことの\n絶えてしなくば\nなかなかに", kami_f: "おうことの\nたえてしなくば\nなかなかに", shimo: "人をも身をも\n恨みざらまし", shimo_f: "ひとをもみをも\nうらみざらまし", meaning: "逢うことが全くないのであれば、かえってあの人を、また我が身を恨むこともないだろうに。" },
            { id: 45, kami: "あはれとも\n言ふべき人は\n思ほえで", kami_f: "あわれとも\nいうべきひとは\nおもほえで", shimo: "身のいたづらに\nなりぬべきかな", shimo_f: "みのいたづらに\nなりぬべきかな", meaning: "「かわいそうだ」と言ってくれるはずの人は、そう思ってくれず、私の身はむなしく終わってしまいそうだ。" },
            { id: 46, kami: "由良の門を\n渡る舟人\n梶を絶え", kami_f: "ゆらのとを\nわたるふなびと\nかじをたえ", shimo: "ゆくへも知らぬ\n恋の道かな", shimo_f: "ゆくえもしらぬ\nこいのみちかな", meaning: "由良の湊を渡る舟人が、舵を失ってどこへ行くかわからなくなっているように、私の恋の行方もわからないことだ。" },
            { id: 47, kami: "八重葎\nしげれる宿の\nさびしさに", kami_f: "やえむぐら\nしげれるやどの\nさびしさに", shimo: "人こそ見えね\n秋は来にけり", shimo_f: "ひとこそみえね\nあきはきにけり", meaning: "幾重にも草が生い茂った寂しい宿には、訪れる人は見えないけれど、秋だけはやってきたようだ。" },
            { id: 48, kami: "風をいたみ\n岩打つ波の\nおのれのみ", kami_f: "かぜをいたみ\nいわうつなみの\nおのれのみ", shimo: "砕けてものを\n思ふ頃かな", shimo_f: "くだけてものを\nおもうころかな", meaning: "風が激しいので、岩に打ちつける波が、自分だけが砕け散るように、私一人で辛い恋の物思いをしている頃であるよ。" },
            { id: 49, kami: "みかき守\n衛士のたく火の\n夜は燃え", kami_f: "みかきもり\nえじのたくひの\nよはもえ", shimo: "昼は消えつつ\nものをこそ思へ", shimo_f: "ひるはきえつつ\nものをこそおもえ", meaning: "宮中の警護の衛士が焚く篝火が、夜は燃え、昼は消えるように、私も夜は激しく燃え上がり、昼は消え入るように、恋の物思いをしている。" },
            { id: 50, kami: "君がため\n惜しからざりし\n命さへ", kami_f: "きみがため\nおしからざりし\nいのちさえ", shimo: "長くもがなと\n思ひけるかな", shimo_f: "ながくもがなと\nおもいけるかな", meaning: "あなたに逢うためなら惜しくないと思っていた命さえも、逢った今となっては、もっと長くありたいと思うようになったことだ。" },
            { id: 51, kami: "かくとだに\nえやはいぶきの\nさしも草", kami_f: "かくとだに\nえやはいぶきの\nさしもぐさ", shimo: "さしも知らじな\n燃ゆる思ひを", shimo_f: "さしも知らじな\nもゆるおもいを", meaning: "（苦しい恋心を）「こうだ」とさえ言うこともできない。伊吹山のサシモ草（燃えやすい草）のように、これほど燃えるような私の思いを、あなたはまさか知らないだろう。" },
            { id: 52, kami: "明けぬれば\n暮るるものとは\n知りながら", kami_f: "あけぬれば\nくるるものとは\nしりながら", shimo: "なほ恨めしき\n朝ぼらけかな", shimo_f: "なほうらめしき\nあさぼらけかな", meaning: "夜が明ければ必ず日が暮れるものだとは知っているけれど、それでもやはり恨めしく思われるこの夜明けであるよ。" },
            { id: 53, kami: "嘆きつつ\nひとり寝る夜の\n明くるまは", kami_f: "なげきつつ\nひとりぬるよの\nあくるまは", shimo: "いかに久しき\nものとかは知る", shimo_f: "いかにひさしき\nものとかはしる", meaning: "嘆きながら一人で寝る夜が明けるまでの時間は、どれほど長いものだとあなたは知っているだろうか。（知るはずがない）" },
            { id: 54, kami: "忘れじの\n行く末までは\nかたければ", kami_f: "わすれじの\nゆくすえまでは\nかたければ", shimo: "今日を限りの\n命ともがな", shimo_f: "きょうをかぎりの\nいのちともがな", meaning: "「忘れまい」というあなたの約束が、この先まで守り通すのは難しいのならば、いっそ今日を限りに私の命が終わってしまえばいいのに。" },
            { id: 55, kami: "滝の音は\n絶えて久しく\nなりぬれど", kami_f: "たきのおとは\nたえてひさしく\nなりぬれど", shimo: "名こそ流れて\nなほ聞こえけれ", shimo_f: "なこそながれて\nなほきこえけれ", meaning: "滝の水が涸れて久しくなるが、その名声は流れ伝わって今なお聞こえている。" },
            { id: 56, kami: "あらざらむ\nこの世のほかの\n思ひ出に", kami_f: "あらざらむ\nこのよのほかの\nおもいでに", shimo: "今ひとたびの\n逢ふこともがな", shimo_f: "いまひとたびの\nおうこともがな", meaning: "（私が）もうこの世にいない後の、来世での思い出に、せめてもう一度だけでもあなたに逢いたいものだ。" },
            { id: 57, kami: "めぐり逢ひて\n見しやそれとも\nわかぬ間に", kami_f: "めぐりあいて\nみしやそれとも\nわかぬまに", shimo: "雲隠れにし\n夜半の月影", shimo_f: "くもがくれにし\nよわのつきかげ", meaning: "久しぶりに巡り逢って、その人だと確認できない間に、雲に隠れてしまった夜半の月影のように、あっという間に別れてしまった。" },
            { id: 58, kami: "ありま山\n猪名の笹原\n風吹けば", kami_f: "ありまやま\nいなのささはら\nかぜふけば", shimo: "いでそよ人を\n忘れやはする", shimo_f: "いでそよひとを\nわすれやはする", meaning: "有馬山、猪名の笹原に風が吹けば、笹が「いざよ、いざよ（さあ来い、さあ来い）」と誘うように、いいえ、私はあなたを忘れはしません。" },
            { id: 59, kami: "やすらはで\n寝なましものを\nさ夜ふけて", kami_f: "やすらわで\nねなましものを\nさよふけて", shimo: "傾くまでの\n月を見しかな", shimo_f: "かたぶくまでの\nつきをみしかな", meaning: "（あなたが来ないのなら）迷わずに寝てしまえばよかったものを。夜が更けて、月が西に傾くまで起きて待ってしまったよ。" },
            { id: 60, kami: "大江山\nいく野の道の\n遠ければ", kami_f: "おおえやま\nいくののみちの\nとおければ", shimo: "まだふみもみず\n天の橋立", shimo_f: "まだふみもみず\nあまのはしだて", meaning: "大江山や生野を通る道が遠いので、まだ（文）手紙も見ていないし、天の橋立（文を踏む、という掛詞）も見ていない。" },
            { id: 61, kami: "いにしへの\n奈良の都の\n八重桜", kami_f: "いにしえの\nならのみやこの\nやえざくら", shimo: "けふ九重に\nにほひぬるかな", shimo_f: "きょうここのえに\nにおいぬるかな", meaning: "昔の奈良の都に咲いていた八重桜が、今日は宮中（九重）で美しく咲き誇っていることよ。" },
            { id: 62, kami: "夜をこめて\n鳥のそら音は\nはかるとも", kami_f: "よをこめて\nとりのそらねは\nはかるとも", shimo: "よに逢坂の\n関は許さじ", shimo_f: "よにあうさかの\nせきはゆるさじ", meaning: "まだ夜が明けないうちに、鶏の鳴き声を真似て騙そうとしても、この世に逢坂の関は（夜が明けたといって）決して許しはしまい。" },
            { id: 63, kami: "今はただ\n思ひ絶えなむ\nとばかりを", kami_f: "いまはただ\nおもいたえなむ\nとばかりを", shimo: "人づてならで\nいふよしもがな", shimo_f: "ひとづてならで\nいうよしもがな", meaning: "今となってはただ「もう思いを断ち切ってしまいましょう」という言葉だけでも、人づてではなく直接あなたに言う方法があればいいのに。" },
            { id: 64, kami: "朝ぼらけ\n宇治の川霧\n絶えだえに", kami_f: "あさぼらけ\nうじのかわぎり\nたえだえに", shimo: "あらはれわたる\n瀬々の網代木", shimo_f: "あらはれわたる\nせぜのあじろぎ", meaning: "夜明け方、宇治川の川霧が途切れ途切れになるにつれて、姿を現し流れていく浅瀬の網代木（漁のための仕掛け）であるよ。" },
            { id: 65, kami: "恨みわび\nほさぬ袖だに\nあるものを", kami_f: "うらみわび\nほさぬそでだに\nあるものを", shimo: "恋に朽ちなん\n名こそ惜しけれ", shimo_f: "こいにくちなん\nなこそおしけれ", meaning: "（あなたを）恨みながら、乾かす間もないほど涙で濡れている袖があるのに、恋のせいで朽ちてしまう名声が惜しい。" },
            { id: 66, kami: "もろともに\nあはれと思へ\n山桜", kami_f: "もろともに\nあわれとおもえ\nやまざくら", shimo: "花よりほかに\n知る人もなし", shimo_f: "はなよりほかに\nしるひともなし", meaning: "（この世の無常を）私と一緒に心からしみじみと感じておくれ、山桜よ。ここではお前以外に心を知る人もいないのだから。" },
            { id: 67, kami: "春の夜の\n夢ばかりなる\n手枕に", kami_f: "はるのよの\nゆめばかりなる\nたまくらに", shimo: "かひなく立たむ\n名こそ惜しけれ", shimo_f: "かひなくたたん\nなこそおしけれ", meaning: "春の夜の夢のように短い手枕（一夜を共にしたこと）で、甲斐もなく立ってしまう浮名（悪い評判）が惜しい。" },
            { id: 68, kami: "心にも\nあらでうき世に\nながらへば", kami_f: "こころにも\nあらでうきよに\nながらえば", shimo: "恋しかるべき\n夜半の月かな", shimo_f: "こいしかるべき\nよわのつきかな", meaning: "本心ではなく、このつらい世に生きながらえるのならば、いつかきっと恋しく思い出すであろう、今見ている夜中の月であるよ。" },
            { id: 69, kami: "嵐吹く\n三室の山の\nもみぢ葉は", kami_f: "あらしふく\nみむろのやまの\nもみじばは", shimo: "竜田の川の\n錦なりけり", shimo_f: "たつたのかわの\nにしきなりけり", meaning: "嵐が吹き荒れる三室山の紅葉の葉は、竜田川の水面に散り敷いて、まるで美しい錦の布のようだ。" },
            { id: 70, kami: "さびしさに\n宿を立ち出でて\nながむれば", kami_f: "さびしさに\nやどをたちいでて\nながむれば", shimo: "いづくも同じ\n秋の夕暮", shimo_f: "いづくもおなじ\nあきのゆうぐれ", meaning: "寂しさに耐えかねて家を出て、あたりを眺めてみると、どこも同じように寂しい秋の夕暮れであるよ。" },
            { id: 71, kami: "夕されば\n門田の稲葉\nおとづれて", kami_f: "ゆうされば\nかどたのいなば\nおとづれて", shimo: "蘆のまろやに\n秋風ぞ吹く", shimo_f: "あしのまろやに\nあきかぜぞふく", meaning: "夕方になると、門前の田の稲葉を揺らして、私の粗末な庵にまで秋風が吹いてくる。" },
            { id: 72, kami: "音に聞く\n高師の浜の\nあだ波は", kami_f: "おとにきく\nたかしのはまの\nあだなみは", shimo: "かけじや袖の\n濡れもこそすれ", shimo_f: "かけじやそでの\nぬれもこそすれ", meaning: "噂に聞く高師の浜の、あだ（浮気）な波ではないが、あなたに心をかけるまい、私の袖が濡れてしまうといけないから。（「袖が濡れる」は涙を流すこと）" },
            { id: 73, kami: "高砂の\n尾の上の桜\n咲きにけり", kami_f: "たかさごの\nおのえのさくら\nさきにけり", shimo: "外山の霞\n立たずもあらなん", shimo_f: "とやまのかすみ\nたたずもあらなん", meaning: "高砂の峰の上の桜が咲いたことだ。人里に近い山の霞よ、どうか立たないでくれ。（霞に隠されずに桜を見たい）" },
            { id: 74, kami: "憂かりける\n人を初瀬の\n山おろしよ", kami_f: "うかりける\nひとをはつせの\nやまおろしよ", shimo: "はげしかれとは\n祈らぬものを", shimo_f: "はげしかれとは\nいのらぬものを", meaning: "つれなかったあの人（の心を変えるように）と、初瀬の観音に願ったのに、その山おろしのように私の心を激しく吹き乱せとは祈らなかったのに。" },
            { id: 75, kami: "契りおきし\nさせもが露を\n命にて", kami_f: "ちぎりおきし\nさせもが露を\nいのちにて", shimo: "あはれ今年の\n秋も去ぬめり", shimo_f: "あわれことしの\nあきもいぬめり", meaning: "（あなたと）約束した「さしも草（させもが露）」の露を、命の頼りとしていたのに、ああ、今年の秋も去ってしまうようだ。" },
            { id: 76, kami: "わたの原\n漕ぎ出でて見れば\nひさかたの", kami_f: "わたのはら\nこぎいでてみれば\nひさかたの", shimo: "雲居にまがふ\n沖つ白波", shimo_f: "くもいにまがう\nおきつしらなみ", meaning: "広大な海原に船を漕ぎ出して見てみると、遥か遠くの白い波が、空の雲と見分けがつかないほどだ。" },
            { id: 77, kami: "瀬をはやみ\n岩にせかるる\n滝川の", kami_f: "せをはやみ\nいわにせかるる\nたきがわの", shimo: "われても末に\nあはむとぞ思ふ", shimo_f: "われてもすえに\nあわんとぞおもう", meaning: "流れが速いので岩に堰き止められる滝川の水が、二つに分かれても、また最後は一つになるように、別れても必ず後にあなたに逢いたいと思う。" },
            { id: 78, kami: "淡路島\n通ふ千鳥の\n鳴く声に", kami_f: "あわじしま\nかようちどりの\nなくこえに", shimo: "いく夜寝覚めぬ\n須磨の関守", shimo_f: "いくよねざめぬ\nすまのせきもり", meaning: "淡路島とを往き来する千鳥が鳴く声に、須磨の関守は幾夜も目を覚ましたことだろう。" },
            { id: 79, kami: "秋風に\nたなびく雲の\nたえ間より", kami_f: "あきかぜに\nたなびくくもの\nたえまより", shimo: "もれ出づる月の\n影のさやけさ", shimo_f: "もれいづるつきの\nかげのさやけさ", meaning: "秋風に横になびく雲の切れ間から、漏れ出てくる月の光の、なんと清らかなことか。" },
            { id: 80, kami: "長からむ\n心も知らず\n黒髪の", kami_f: "ながからん\nこころもしらず\nくろかみの", shimo: "乱れて今朝は\nものをこそ思へ", shimo_f: "みだれてけさは\nものをこそおもえ", meaning: "（私の思いが）長く続くかどうかは自分でもわからないが、今朝は黒髪が乱れるほど、恋の物思いに沈んでいる。" },
            { id: 81, kami: "ほととぎす\n鳴きつる方を\nながむれば", kami_f: "ほととぎす\nなきつるかたを\nながむれば", shimo: "ただ有明の\n月ぞ残れる", shimo_f: "ただありあけの\nつきぞのこれる", meaning: "ほととぎすが鳴いた方角を眺めてみると、そこにはただ有明の月だけが残っている。" },
            { id: 82, kami: "思ひわび\nさても命は\nあるものを", kami_f: "おもいわび\nさてもいのちは\nあるものを", shimo: "憂きにたへぬは\n涙なりけり", shimo_f: "うきにたえぬは\nなみだなりけり", meaning: "恋に悩み苦しんで、かろうじて命はながらえているものの、このつらさに耐えきれないのは涙であることよ。" },
            { id: 83, kami: "世の中よ\n道こそなけれ\n思ひ入る", kami_f: "よのなかよ\nみちこそなけれ\nおもいいる", shimo: "山の奥にも\n鹿ぞ鳴くなる", shimo_f: "やまのおくにも\nしかぞなくなる", meaning: "この世には憂きことばかりで、逃れる道はない。深く思い悩んで分け入った山の奥にも、鹿が悲しげに鳴いている。" },
            { id: 84, kami: "ながらへば\nまたこの頃や\nしのばれむ", kami_f: "ながらえば\nまたこのごろや\nしのばれん", shimo: "憂しと見し世ぞ\n今は恋しき", shimo_f: "うしとみしよぞ\nいまはこいしき", meaning: "もし長生きするなら、またこの辛い頃のことも、懐かしく思い出されるのだろうか。つらいと思っていた過去の世さえ、今となっては恋しいのだから。" },
            { id: 85, kami: "夜もすがら\n物思ふころは\n明けにけり", kami_f: "よもすがら\nものおもうころは\nあけにけり", shimo: "暁烏の\n鳴きつつ行かむ", shimo_f: "あかつきがらすの\nなきつつゆかん", meaning: "一晩中物思いをしていたこの頃は、夜が明けてしまった。夜明けを告げるカラスが鳴きながら飛び去っていくよ。" },
            { id: 86, kami: "嘆けとて\n月やは物を\n思はする", kami_f: "なげけとて\nつきやはものを\nおもわする", shimo: "かこち顔なる\nわが涙かな", shimo_f: "かこちがおなる\nわがなみだかな", meaning: "「嘆け」と言って月が私に物思いをさせているのだろうか。いや、そうではないのに、月のせいだと愚痴をこぼしているかのような私の涙であるよ。" },
            { id: 87, kami: "村雨の\n露もまだひぬ\nまきの上に", kami_f: "むらさめの\nつゆもまだひぬ\nまきのうえに", shimo: "霧立ちのぼる\n秋の夕暮", shimo_f: "きりたちのぼる\nあきのゆうぐれ", meaning: "村雨が降った後の露もまだ乾かない槇（まき）の木の上に、霧が立ち上っている秋の夕暮れであるよ。" },
            { id: 88, kami: "難波江の\n芦のかりねの\nひとよゆゑ", kami_f: "なにはえの\nあしのかりねの\nひとよゆえ", shimo: "みをつくしてや\n恋ひわたるべき", shimo_f: "みをつくしてや\nこいわたるべき", meaning: "難波江の芦の仮寝（かりね＝一時的な眠り）の一夜だけの逢瀬のために、澪標（みおつくし）のように身を尽くして、ずっと恋い続けなければならないのだろうか。" },
            { id: 89, kami: "玉の緒よ\n絶えなば絶えね\nながらへば", kami_f: "たまのおよ\nたえなばたえね\nながらえば", shimo: "忍ぶることの\n弱りもぞする", shimo_f: "しのぶることの\nよわりもぞする", meaning: "命よ、絶えるなら絶えてしまえ。もし生き長らえれば、この恋を忍ぶ心が弱ってしまうかもしれないから。" },
            { id: 90, kami: "見せばやな\n雄島の海士の\n袖だにも", kami_f: "みせばやな\nおじまのあまの\nそでだにも", shimo: "濡れにぞ濡れし\n色は変はらず", shimo_f: "ぬれにぞぬれし\nいろはかわらず", meaning: "（恋の涙で濡れた）私の袖を見せたいものだ。雄島の漁師の袖でさえ、海水で濡れはしても、色は変わらないというのに。（私の袖は涙で色が変わるほど濡れている）" },
            { id: 91, kami: "きりぎりす\n鳴くや霜夜の\nさむしろに", kami_f: "きりぎりす\nなくやしもよの\nさむしろに", shimo: "衣かたしき\nひとりかも寝ん", shimo_f: "ころもかたしき\nひとりかもねん", meaning: "きりぎりすが鳴いている霜の降る夜の、寒いむしろに、着物を片敷いて私は一人で寝るのだろうか。" },
            { id: 92, kami: "わが袖は\n潮干に見えぬ\n沖の石の", kami_f: "わがそでは\nしおひにみえぬ\nおきのいしの", shimo: "人こそ知らね\nかわくまもなし", shimo_f: "ひとこそしらね\nかわくまもなし", meaning: "私の袖は、潮が引いても見えない沖の石のように、人には知られないけれど、涙で乾く暇がない。" },
            { id: 93, kami: "世の中は\n常にもがもな\n渚漕ぐ", kami_f: "よのなかは\nつねにもがもな\nなぎさこぐ", shimo: "海人の小舟の\n綱手かなしも", shimo_f: "あまのこぶねの\nつなでかなしも", meaning: "この世はいつまでも変わらないものであってほしいなあ。渚を漕ぎ進む漁師の小舟を引く綱のように、頼りなく切ないことだ。" },
            { id: 94, kami: "みよし野の\n山の白雪\n踏み分けて", kami_f: "みよしのの\nやまのしらゆき\nふみわけて", shimo: "入りにし人ぞ\n音もなくなりぬ", shimo_f: "いりにしひとぞ\nおともなくなりぬ", meaning: "吉野の山に積もった白雪を踏み分けて入って行った人は、音信不通になってしまった。" },
            { id: 95, kami: "おほけなく\nうき世の民に\nおほふかな", kami_f: "おおけなく\nうきよのたみに\nおほふかな", shimo: "わが立つ杣に\n墨染の袖", shimo_f: "わがたつそまに\nすみぞめのそで", meaning: "身の程知らずにも、この憂き世の民を覆い守ってやろうか。私が修行している比叡山で着る墨染めの衣の袖で。（民衆の苦しみを救いたいという慈悲の心）" },
            { id: 96, kami: "花さそふ\n嵐の庭の\n雪ならで", kami_f: "はなさそう\nあらしのにはの\nゆきならで", shimo: "ふりゆくものは\nわが身なりけり", shimo_f: "ふりゆくものは\nわがみなりけり", meaning: "桜の花を誘って散らす嵐が吹く庭の、花吹雪（雪）ではなく、降り積もっていくものは、我が身の老い（年齢）であったことよ。" },
            { id: 97, kami: "来ぬ人を\n松帆の浦の\n夕なぎに", kami_f: "こぬひとを\nまつほのうらの\nゆうなぎに", shimo: "焼くや藻塩の\n身もこがれつつ", shimo_f: "やくやもしおの\nみもこがれつつ", meaning: "来ないあの人を（松ほ＝待つを）待つ、松帆の浦の夕凪に焼く藻塩のように、私も身を焦がしながら恋い焦がれている。" },
            { id: 98, kami: "風そよぐ\nならの小川の\n夕暮れは", kami_f: "かぜそよぐ\nならのおがわの\nゆうぐれは", shimo: "みそぎぞ夏の\nしるしなりける", shimo_f: "みそぎぞなつの\nしるしなりける", meaning: "風がそよそよと音を立てるならの小川の夕暮れは、涼しげで秋のようだが、行われているみそぎ（祓え）だけが夏のしるしであるよ。" },
            { id: 99, kami: "ももしくや\n古き軒端の\nしのぶにも", kami_f: "ももしきや\nふるきのきばの\nしのぶにも", shimo: "なほあまりある\n昔なりけり", shimo_f: "なほあまりある\nむかしなりけり", meaning: "宮中の古びた軒先に生えている忍（しのぶぐさ）を見ても、それでもなお思い出しきれないほど、懐かしい昔の世であったことよ。" },
            { id: 100, kami: "大君は\n神にしあらず\nますらをの", kami_f: "おほきみは\nかみにしあらず\nますらをの", shimo: "ふねのつまもりに\nたつなみやどる", shimo_f: "ふねのつまもりに\nたつなみやどる", meaning: "天皇は神ではない。立派な男子である私が、船の舳先（へさき）を守る時に立つ波のように、命がけであなたを護る（つまもり）でしょう。" }
        ];

        let playerScore = 0;
        let cpuScore = 0;
        let currentRound = 0;
        const MAX_ROUNDS = 100; 
        let isReading = false;
        let isGameActive = false;
        let correctAnswerId = null;
        let cpuTimeout = null;
        let availableCards = []; 

        // 💡 修正: CPUの反応時間設定を「読み上げ完了後」のディレイとして定義
        const difficultySettings = {
            easy: { postReadDelay: 5000, missChance: 0.1 },      // 5秒後
            normal: { postReadDelay: 3000, missChance: 0.05 },   // 3秒後
            hard: { postReadDelay: 0, minJitter: 0, maxJitter: 1000, missChance: 0.01 }, // 読み終わり直後～1秒
        };
        
        const scorePlayerEl = document.getElementById('player-score');
        const scoreCpuEl = document.getElementById('cpu-score');
        const readingTextEl = document.getElementById('reading-text');
        const instructionsEl = document.getElementById('instructions');
        const cardOptionsEl = document.getElementById('card-options');
        const meaningDisplayEl = document.getElementById('meaning-display');
        const difficultySelectEl = document.getElementById('difficulty');
        const startButtonEl = document.getElementById('start-button');
        const resetButtonEl = document.getElementById('reset-button'); 
        const nextRoundButtonEl = document.getElementById('next-round-button'); 
        const resultModalEl = document.getElementById('result-modal');
        const finalMessageEl = document.getElementById('final-message');

        const utterance = new SpeechSynthesisUtterance();
        utterance.lang = 'ja-JP';

        /**
         * 日本語の句を読み上げる
         * 💡 修正: 読み上げ完了後にCPU反応処理を開始するように変更
         */
        function speak(text, cardId) {
            utterance.text = text.replace(/\n/g, ' '); 
            
            utterance.onend = () => {
                // 読み上げが完全に終わった後、CPUの反応タイマーをセット
                setCpuReaction(cardId);
            };
            
            // 読み上げ開始時にisReadingをtrueにし、プレイヤーの入力を許可する
            isReading = true; 
            window.speechSynthesis.speak(utterance);
        }

        /**
         * ゲームを初期化して開始
         */
        function startGame() {
            if (isGameActive) return;
            
            if (KARUTA_DATA.length < 100) {
                alert(`致命的なエラー：百人一首100首すべてのデータが不足しています。現在 ${KARUTA_DATA.length} 枚です。`);
                return;
            }

            playerScore = 0;
            cpuScore = 0;
            currentRound = 0;
            
            const shuffledKaruta = [...KARUTA_DATA].sort(() => Math.random() - 0.5);
            availableCards = shuffledKaruta; 
            
            isGameActive = true;
            scorePlayerEl.textContent = playerScore;
            scoreCpuEl.textContent = cpuScore;
            readingTextEl.textContent = "第一回戦を開始します。";
            instructionsEl.textContent = '🔊 音声を聞いて、読み上げた上の句に合う下の句を早く取ろう！';
            meaningDisplayEl.style.opacity = '0';
            startButtonEl.disabled = true;
            difficultySelectEl.disabled = true;
            resetButtonEl.disabled = false;
            nextRoundButtonEl.style.display = 'none';

            setTimeout(nextRound, 2000);
        }

        /**
         * ゲームをリセット（初期状態に戻す）する
         */
        function resetGame() {
            if (isGameActive && !confirm('本当にゲームをリセットして最初からやり直しますか？')) {
                return;
            }
            
            window.speechSynthesis.cancel(); 
            clearTimeout(cpuTimeout); 
            isGameActive = false; 

            playerScore = 0;
            cpuScore = 0;
            currentRound = 0;
            isReading = false;
            correctAnswerId = null;
            availableCards = [];
            
            scorePlayerEl.textContent = '0';
            scoreCpuEl.textContent = '0';
            readingTextEl.textContent = '「ゲーム開始」ボタンを押して、遊んでみよう！';
            instructionsEl.textContent = '難易度を選んでね。計100枚勝負です。'; 
            cardOptionsEl.innerHTML = '';
            meaningDisplayEl.style.opacity = '0';
            
            startButtonEl.disabled = false;
            difficultySelectEl.disabled = false;
            resetButtonEl.disabled = true;
            nextRoundButtonEl.style.display = 'none';
            resultModalEl.style.display = 'none';
        }


        /**
         * 次のラウンド（句の出題）へ進む
         */
        function nextRound() {
            nextRoundButtonEl.style.display = 'none'; 

            if (currentRound >= MAX_ROUNDS) {
                endGame();
                return;
            }

            currentRound++; 
            readingTextEl.textContent = `第 ${currentRound} 回戦 (${MAX_ROUNDS}戦中)...`; 
            cardOptionsEl.innerHTML = '';
            meaningDisplayEl.style.opacity = '0';
            clearTimeout(cpuTimeout);
            
            const correctCard = availableCards[currentRound - 1]; 
            
            if (!correctCard) {
                readingTextEl.innerHTML = `致命的なエラー: ${currentRound}回戦目の句データがリストから見つかりません。`;
                endGame();
                return;
            }

            correctAnswerId = correctCard.id;
            
            let incorrectCards = [];
            const allIncorrectCandidates = KARUTA_DATA.filter(card => card.id !== correctAnswerId);

            // 誤答の選択肢を2つ選ぶ
            while (incorrectCards.length < 2 && allIncorrectCandidates.length > 0) {
                const randomIndex = Math.floor(Math.random() * allIncorrectCandidates.length);
                const selectedCard = allIncorrectCandidates[randomIndex];
                incorrectCards.push(selectedCard);
                allIncorrectCandidates.splice(randomIndex, 1);
            }
            
            let options = [correctCard, ...incorrectCards];
            options.sort(() => Math.random() - 0.5);
            
            options.forEach((card, index) => {
                const cardEl = createCardElement(card, index);
                cardOptionsEl.appendChild(cardEl);
            });

            startReading(correctCard);
        }

        /**
         * 札のDOM要素を作成
         */
        function createCardElement(card, index) {
            const cardEl = document.createElement('div');
            cardEl.className = 'karuta-card';
            cardEl.dataset.id = card.id;
            cardEl.dataset.index = index;
            
            // 💡 修正: クリック時に直接判定関数を呼ぶ
            cardEl.onclick = (e) => {
                // イベント伝播を停止して、二重処理を防ぐ
                e.stopPropagation();
                handleCardClick(card.id, 'player', index);
            };
            
            const textLines = card.shimo.split('\n');
            const furiLines = card.shimo_f.split('\n');

            let innerHTML = '';
            // 最初の行にだけフリガナを表示する（札のデザインをシンプルに保つため）
            if(furiLines[0]) {
                innerHTML += `<span class="furigana">${furiLines.join('')}</span>`;
            }
            innerHTML += `<div class="card-content">`;
            for(let i = 0; i < textLines.length; i++) {
                innerHTML += `<div class="card-text">${textLines[i]}</div>`;
            }
            innerHTML += `</div>`;


            cardEl.innerHTML = innerHTML;
            return cardEl;
        }

        /**
         * 読み上げ（上の句の表示と音声）を開始
         */
        function startReading(card) {
            const kamiTextLines = card.kami.split('\n');
            const kamiFuriLines = card.kami_f.split('\n');
            
            let displayHTML = '';
            for(let i = 0; i < kamiTextLines.length; i++) {
                if(kamiFuriLines[i]) {
                    displayHTML += `<span class="furigana" style="font-size:0.5em; opacity:1; position:relative; transform:none; top:0;">${kamiFuriLines[i]}</span><br>`;
                }
                displayHTML += `${kamiTextLines[i]}<br>`;
            }
            readingTextEl.innerHTML = displayHTML;
            
            // 読み上げ開始
            speak(card.kami, card.id);
            // isReading = true は speak 関数内でセットされます
        }

        /**
         * CPUの反応ロジック
         * 💡 修正: 読み上げ完了後に呼び出される
         */
        function setCpuReaction(correctId) {
            const diff = difficultySelectEl.value;
            const settings = difficultySettings[diff];
            
            let reactionTime;

            if (diff === 'hard') {
                // 強い: 0ms～1000ms のランダムな反応時間
                reactionTime = Math.random() * (settings.maxJitter - settings.minJitter) + settings.minJitter;
            } else {
                // かんたん/そこそこ: 読み上げ完了後のディレイを設定
                reactionTime = settings.postReadDelay; 
            }
            
            cpuTimeout = setTimeout(() => {
                let cpuChoiceId;
                const isMiss = Math.random() < settings.missChance;
                
                if (isMiss) {
                    // 間違いを引く
                    const incorrectOptions = Array.from(cardOptionsEl.children)
                        .map(el => parseInt(el.dataset.id))
                        .filter(id => id !== correctId);
                    
                    if (incorrectOptions.length > 0) {
                        cpuChoiceId = incorrectOptions[Math.floor(Math.random() * incorrectOptions.length)];
                    } else {
                        cpuChoiceId = correctId; // 間違える札がない場合は正解を取る
                    }
                } else {
                    // 正解を引く
                    cpuChoiceId = correctId;
                }

                // CPUが処理を実行する直前で、まだ読み上げが終了し、ゲームがアクティブか再確認
                if (isGameActive && !isReading) { 
                    handleCardClick(cpuChoiceId, 'cpu', -1);
                }
                // isReadingがfalse（プレイヤーが先に取った）場合は何もしない
            }, reactionTime);
        }


        /**
         * 札をクリック/選択した時の処理 (反応不良修正ロジック)
         */
        function handleCardClick(selectedId, selector, index) {
            // 💡 修正: 判定開始時にisReadingフラグを即座にチェックし、クリアする
            if (!isGameActive) return; 
            
            // isReadingがfalse（既に誰かが取った後）であれば、二重処理を防ぐために終了
            if (!isReading && selector === 'player') return; 

            // 誰かがクリック/反応したら、CPUタイマーと音声読み上げを即座に停止
            clearTimeout(cpuTimeout); 
            window.speechSynthesis.cancel(); 
            isReading = false; // 判定が始まったらすぐにフラグを落とす

            const isCorrect = (selectedId === correctAnswerId);
            const cardElements = Array.from(cardOptionsEl.children);
            let resultMessage = '';
            
            if (isCorrect) {
                if (selector === 'player') {
                    playerScore++;
                    scorePlayerEl.textContent = playerScore;
                    resultMessage = `🎉 あなたの勝ち！`;
                } else {
                    cpuScore++;
                    scoreCpuEl.textContent = cpuScore;
                    resultMessage = `🤖 CPUの勝ち！`;
                }
                
                const correctCardEl = cardElements.find(el => parseInt(el.dataset.id) === selectedId);
                if (correctCardEl) {
                    correctCardEl.style.backgroundColor = 'var(--color-highlight)'; 
                }

            } else {
                
                if (selector === 'cpu') {
                    // CPUが間違えた場合、プレイヤーの得点
                    playerScore++;
                    scorePlayerEl.textContent = playerScore;
                    resultMessage = '🎊 CPUが間違えたのであなたの勝ち！';
                } else {
                    // プレイヤーが間違えた場合、CPUの得点
                    cpuScore++;
                    scoreCpuEl.textContent = cpuScore;
                    resultMessage = '❌ 間違えた！CPUの勝ち！';
                }
                
                // プレイヤーが取った札を赤く、正解の札を緑にハイライト
                if (selector === 'player' && index !== -1) {
                    cardElements[index].style.backgroundColor = 'var(--color-accent)'; 
                }
                
                const correctCardEl = cardElements.find(el => parseInt(el.dataset.id) === correctAnswerId);
                if (correctCardEl) {
                    correctCardEl.style.backgroundColor = '#D0FFD0'; // 正解は薄い緑
                }
            }
            
            const takenCard = KARUTA_DATA.find(card => card.id === correctAnswerId);
            readingTextEl.innerHTML = `<span style="color:${isCorrect ? 'var(--color-highlight)' : 'var(--color-accent)'};">${resultMessage}</span>`;
            
            meaningDisplayEl.innerHTML = `**【句の意味】** ${takenCard.meaning}`;
            meaningDisplayEl.style.opacity = '1';

            // 次のラウンドへ進むボタンの表示
            if (currentRound < MAX_ROUNDS) {
                nextRoundButtonEl.style.display = 'inline-block';
            } else {
                endGame(); 
            }
        }

        /**
         * ゲーム終了処理
         */
        function endGame() {
            isGameActive = false;
            startButtonEl.disabled = true;
            difficultySelectEl.disabled = true;
            nextRoundButtonEl.style.display = 'none';

            let message;

            if (playerScore > cpuScore) {
                message = `🏆 最終結果: ${playerScore}対${cpuScore} で**あなたの勝利です！** 素晴らしい！`;
            } else if (cpuScore > playerScore) {
                message = `残念！ 最終結果: ${playerScore}対${cpuScore} で**CPUの勝利です。** 次は頑張ろう！`;
            } else {
                message = `引き分け！ 最終結果: ${playerScore}対${cpuScore} です。`;
            }

            finalMessageEl.innerHTML = message;
            resultModalEl.style.display = 'flex';
        }

        // =======================================
        // イベントリスナー
        // =======================================
        startButtonEl.addEventListener('click', startGame);
        resetButtonEl.addEventListener('click', resetGame);
        nextRoundButtonEl.addEventListener('click', nextRound);

        // 初期表示設定
        resetButtonEl.disabled = true;

    </script>
</body>
</html>
